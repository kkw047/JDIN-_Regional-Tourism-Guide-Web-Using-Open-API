<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 여행 현황</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
        color: #343a40;
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #eee;
    }

    #map {
        width: 100%;
        height: 500px;
        background-color: #dcdcdc;
        border: 1px solid #ccc;
        margin-bottom: 20px;
        border-radius: 8px;
        position: relative; /* #dragM 버튼의 기준이 되도록 */
    }

    .map-footer {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 2; /* 다른 지도 요소 위에 오도록 */
    }

    .user-code {
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        font-size: 14px;
        z-index: 2; /* 다른 지도 요소 위에 오도록 */
    }

    .destination-info { /* 이 ID를 사용하는 요소가 HTML에 없지만, 스타일은 유지 */
        text-align: center;
        font-size: 16px;
        font-weight: bold;
    }

    .site-list {
        list-style: none;
        padding: 0;
    }

    .site-item {
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
    }

    .grid-container {
        display: grid;
        grid-template-columns: minmax(150px, auto) 1fr;
        grid-gap: 10px;
        align-items: center;
        margin: 0 auto;
        width: fit-content;
    }

    .site-info {
        text-align: center;
        padding-right: 75px;
    }

    .site-button {
        text-align: left;
        padding-left: 75px;
    }

    .arrow-row {
        text-align: center;
        padding-right: 75px;
    }

    .route-button {
        text-align: left;
        padding-left: 75px;
    }

    .arrow {
        font-size: 24px;
        display: block;
        margin: 0 auto;
    }

    .status-button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .status-button.waiting {
        background-color: #dc3545;
    }

    .status-button.in-progress {
        background-color: #007bff;
    }

    .status-button.completed {
        background-color: #28a745;
    }

    .status-button.waiting.blinking,
    .status-button.in-progress.blinking {
        animation: blinker 1s linear infinite;
    }

    @keyframes blinker {
        50% {
            opacity: 0.5;
        }
    }

    .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border: 1px solid #ccc;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }

    .tmap-marker img { /* Tmap 마커 이미지 크기 (필요 시 조정) */
        width: 65px;
        height: 30px;
    }

    .site-image { /* 사용되지 않는 클래스지만, 필요 시 사용 가능 */
        width: 150px;
        height: 100px;
        margin-right: 20px;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .site-placeholder { /* 사용되지 않는 클래스지만, 필요 시 사용 가능 */
        width: 150px;
        height: auto;
        aspect-ratio: 3 / 2;
        background-color: #dee2e6;
        margin-right: 20px;
        border-radius: 6px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #adb5bd;
        font-size: 14px;
    }

    .complete-button-container {
        text-align: center;
        margin-top: 20px;
    }

    .complete-button {
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        background-color: #28a745;
        transition: background-color 0.3s;
    }

    .complete-button:hover {
        background-color: #218838;
    }

    #dragM { /* 미션 버튼 */
        position: absolute; /* #map 내부에서 절대 위치 */
        top: 10px;
        left: 10px;
        width: 50px;
        height: 50px;
        background-image: url('/static/m_icon.png');
        background-size: cover;
        cursor: move;
        z-index: 1000; /* 다른 지도 요소 위에 오도록 */
    }

    #missionPopupContainer { /* 미션 팝업 창 */
        position: fixed; /* 화면 기준으로 고정 위치 */
        /* top, left는 JS에서 동적으로 설정 */
        width: 400px;
        height: 75%;
        max-height: 750px;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1001; /* 미션 버튼보다 위에 오도록 */
        display: none;
        border-radius: 8px;
        overflow: hidden;
    }

    #missionPopup { /* 미션 내용 iframe */
        width: 100%;
        height: 100%;
        border: none;
    }

    #closeButton { /* 미션 팝업 닫기 버튼 */
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1002; /* iframe 위에 오도록 */
        font-size: 14px;
        line-height: 1;
    }
    #closeButton:hover {
        background-color: #c0392b;
    }

    .toast-message {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        z-index: 10000; /* 최상단에 보이도록 */
        opacity: 0;
        transition: opacity 0.3s, bottom 0.3s;
        pointer-events: none; /* 메시지 클릭 방지 */
    }

    .toast-message.show {
        opacity: 1;
        bottom: 30px;
    }
</style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=Mb9cttQ9De2UcPzNfNwCl7ZRY31kNiUqPjCAeZne&callback=tmapApiLoaded"></script>
</head>

<body>
    <div class="container">
        <h1>실시간 여행 현황</h1>
        <div id="map">
            <div id="dragM"></div>
            <div class="map-footer">
                <div class="user-code" onclick="copyUserCode()">User Code: {{ usercode }}</div>
            </div>
        </div>

        <ul class="site-list">
    {% for i in range(count) %}
    <li class="site-item">
        <div class="grid-container">
            <div class="site-info">
                {% if tourist_sites[i] %}{{ tourist_sites[i].name }}{% else %}정보 없음{% endif %}
            </div>
            <div class="site-button">
                {% if statuses[i] == 0 %}
                    {% if i == 0 or (statuses[i-1] == 1 and (i == 1 or (routes[i-1] and routes[i-1].status == 1))) %}
                        <button class="status-button waiting" onclick="openPopup('site', '{{ usercode }}', {{ i + 1 }}, 2)">대기</button>
                    {% else %}
                        <button class="status-button waiting" disabled>대기</button>
                    {% endif %}
                {% elif statuses[i] == 2 %}
                    <button class="status-button in-progress blinking" onclick="openCompletePopup('{{ usercode }}', {{ i + 1 }})">진행중</button>
                {% elif statuses[i] == 1 %}
                    <button class="status-button completed" onclick="openCancelPopup('site', '{{ usercode }}', {{ i + 1 }})">완료</button>
                {% endif %}
            </div>

            {% if i < count - 1 and routes[i] %}
            <div class="arrow-row">
                <div class="arrow {% if routes[i].status == 2 %}blinking{% endif %}">↓</div>
            </div>
            <div class="route-button">
                {% if routes[i].status == 0 %}
                    {% if statuses[i] == 1 %}
                        <button class="status-button waiting" onclick="openPopup('route', '{{ usercode }}', {{ i + 1 }}, 2)">대기</button>
                    {% else %}
                        <button class="status-button waiting" disabled>대기</button>
                    {% endif %}
                {% elif routes[i].status == 2 %}
                    <button class="status-button in-progress blinking" onclick="openPopup('route', '{{ usercode }}', {{ i + 1 }}, 1)">진행중</button>
                {% elif routes[i].status == 1 %}
                    <button class="status-button completed" onclick="openCancelPopup('route', '{{ usercode }}', {{ i + 1 }})">완료</button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </li>
    {% endfor %}
</ul>

        {% if statuses and statuses[-1] == 1 %}
        <div class="complete-button-container">
            <button class="complete-button" onclick="completeAll()">여행 완료</button>
        </div>
        {% endif %}

        <div class="popup" id="statusPopup">
            <h2 id="statusPopupTitle">상태 변경 확인</h2> <p id="popupMessage"></p>
            <button onclick="updateStatus()">예</button>
            <button onclick="closePopup()">아니오</button>
        </div>

        <div class="popup" id="cancelPopup">
            <h2>취소 확인</h2>
            <p>정말로 취소하시겠습니까? 현재 진행 단계로 돌아가며 이후 모든 단계는 초기화됩니다.</p>
            <button onclick="cancelStatus()">예</button>
            <button onclick="closePopup()">아니오</button>
        </div>

        <div class="popup" id="completePopup">
            <h2>여행 완료 확인</h2>
            <p id="completePopupMessage">여행을 완료하셨습니까?</p> <button onclick="completeStatus()">예</button>
            <button onclick="closePopup()">아니오</button>
        </div>

        <div class="popup" id="confirmCompletePopup">
            <h2>모든 여행이 완료되었습니다!</h2>
            <p>후기를 작성하시겠습니까?</p>
            <button class="status-button completed" onclick="confirmReview()">예</button>
            <button class="status-button waiting" onclick="acknowledgeComplete()">아니오</button>
            <button class="status-button" style="background-color: #6c757d; margin-left: 10px;" onclick="closePopup()">닫기</button>
        </div>

        <div class="overlay" id="popupOverlay"></div>

        <div id="missionPopupContainer">
            <button id="closeButton" onclick="closeMissionPopup(false)">닫기</button> <iframe id="missionPopup" src="about:blank" ></iframe> </div>
        <div id="toastMessage" class="toast-message"></div>
    </div>

<script>
    let map;
    let markers = [];
    let polylines = [];
    let usercode = '{{ usercode }}';
    let currentType = '';
    let currentUsercode = '{{ usercode }}'; // 초기화
    let currentNumber = 0;
    let newStatus = 0;
    let touristSites = {{ tourist_sites | tojson }};
    let statuses = {{ statuses | tojson }};
    let routes = {{ routes | tojson }};
    let tmapLoaded = false;
    let infoWindow;
    const apiKey = "Mb9cttQ9De2UcPzNfNwCl7ZRY31kNiUqPjCAeZne"; //
    const startIcon = "/static/start.png"; //
    const middleIcon = "/static/middle.png"; //
    const endIcon = "/static/end.png"; //
    let city = "서울";

    let isMissionPopupOpen = false;
    let dragOffsetDiff = { left: 0, top: 0 };

    function openPopup(type, code, number, status) { // usercode -> code 파라미터명 변경
        console.log("openPopup 호출", type, code, number, status);
        currentType = type;
        currentUsercode = code;
        currentNumber = number;
        newStatus = status;

        let popupMessage = "";
        let popupTitle = "상태 변경 확인"; // 기본 팝업 제목

        if (type === 'site') {
            const siteName = touristSites[number-1] ? touristSites[number-1].name : `관광지 ${number}`;
            if (statuses[number - 1] === 0) {
                popupMessage = `"${siteName}" 여행을 시작하시겠습니까?`;
                popupTitle = "여행 시작";
            } else if (statuses[number - 1] === 2) { // 이 경우는 completePopup으로 직접 감
                popupMessage = `"${siteName}" 여행을 완료하셨습니까?`;
                popupTitle = "여행 완료";
            } else if (statuses[number - 1] === 1) { // 이 경우는 cancelPopup으로 직접 감
                popupMessage = `"${siteName}" 여행을 취소하시겠습니까?`;
                popupTitle = "여행 취소";
            }
        } else if (type === 'route') {
            const routeDesc = touristSites[number-1] && touristSites[number] ? `"${touristSites[number-1].name}"에서 "${touristSites[number].name}"로의 경로` : `경로 ${number}`;
            if (routes[number - 1].status === 0) {
                popupMessage = `${routeDesc} 이동을 시작하시겠습니까?`;
                popupTitle = "경로 시작";
            } else if (routes[number - 1].status === 2) {
                popupMessage = `${routeDesc} 이동을 완료하시겠습니까?`;
                popupTitle = "경로 완료";
            } else if (routes[number - 1].status === 1) { // 이 경우는 cancelPopup으로 직접 감
                popupMessage = `${routeDesc} 이동을 취소하시겠습니까?`;
                popupTitle = "경로 취소";
            }
        }
        document.getElementById('popupMessage').innerText = popupMessage;
        document.getElementById('statusPopupTitle').innerText = popupTitle;


        document.getElementById('statusPopup').style.display = 'block';
        document.getElementById('cancelPopup').style.display = 'none';
        document.getElementById('completePopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function openCompletePopup(code, number) { // usercode -> code 파라미터명 변경
        console.log("openCompletePopup 호출", code, number);
        currentUsercode = code;
        currentNumber = number;
        const siteName = touristSites[number-1] ? touristSites[number-1].name : `관광지 ${number}`;
        document.getElementById('completePopupMessage').innerText = `"${siteName}" 여행을 완료하셨습니까?`;


        document.getElementById('statusPopup').style.display = 'none';
        document.getElementById('cancelPopup').style.display = 'none';
        document.getElementById('completePopup').style.display = 'block';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function openCancelPopup(type, code, number) { // usercode -> code 파라미터명 변경
        console.log("openCancelPopup 호출", type, code, number);
        currentType = type;
        currentUsercode = code;
        currentNumber = number;

        document.getElementById('statusPopup').style.display = 'none';
        document.getElementById('cancelPopup').style.display = 'block';
        document.getElementById('completePopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function closePopup() {
        document.getElementById('statusPopup').style.display = 'none';
        document.getElementById('cancelPopup').style.display = 'none';
        document.getElementById('completePopup').style.display = 'none';
        document.getElementById('confirmCompletePopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'none';
    }

    async function updateStatus() {
        let url = '';
        let data = { usercode: currentUsercode }; // currentUsercode 사용

        if (currentType === 'site') {
            url = '/update_status';
            data.site_number = currentNumber;
            data.new_status = newStatus;
        } else if (currentType === 'route') {
            url = '/update_route_status';
            data.route_number = currentNumber;
            data.new_status = newStatus;
        } else {
            console.error("Unknown currentType:", currentType);
            closePopup();
            return;
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Network response was not ok');
            const result = await response.json();

            if (result.status === 'success') {
                // 자동 상태 전이 로직
                if (currentType === 'site' && newStatus === 2) { // 관광지 시작 시
                     // 특별한 자동 전이 없음 (이미 시작됨)
                } else if (currentType === 'site' && newStatus === 1) { // 관광지 완료 시
                    if (currentNumber < touristSites.length) { // 마지막 관광지가 아니면
                        await updateRouteStatusInternal(currentUsercode, currentNumber, 2); // 다음 경로 진행중으로
                    }
                } else if (currentType === 'route' && newStatus === 2) { // 경로 시작 시
                    // 특별한 자동 전이 없음
                } else if (currentType === 'route' && newStatus === 1) { // 경로 완료 시
                    if (currentNumber < touristSites.length) { // 다음 관광지가 있다면 (경로번호는 1부터 시작, 관광지 인덱스는 0부터)
                       await updateSiteStatusInternal(currentUsercode, currentNumber + 1, 2); // 다음 관광지 진행중으로
                    }
                }
                location.reload();
            } else {
                alert('상태 업데이트 실패: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('상태 업데이트 중 오류 발생');
        }
        closePopup();
    }

    async function completeStatus() { // 관광지 완료 시 호출됨
        try {
            const response = await fetch('/update_status', { // 관광지 상태 업데이트 API
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    usercode: currentUsercode,
                    site_number: currentNumber,
                    new_status: 1 // 완료 상태
                })
            });

            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            if (data.status === 'success') {
                if (currentNumber < touristSites.length) { // 마지막 관광지가 아니면
                    await updateRouteStatusInternal(currentUsercode, currentNumber, 2); // 다음 경로를 '진행중'으로
                }
                location.reload();
            } else {
                alert('상태 업데이트 실패: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('상태 업데이트 중 오류 발생');
        }
        closePopup();
    }

    async function cancelStatus() {
        const dataToCancel = {
            usercode: currentUsercode,
            item_type: currentType,
            item_number: currentNumber
        };

        try {
            const response = await fetch('/update_cancel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToCancel)
            });

            if (!response.ok) throw new Error('Network response was not ok');
            const result = await response.json();
            if (result.status === 'success') {
                location.reload();
            } else {
                alert('상태 취소 실패: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('상태 취소 중 오류 발생');
        }
        closePopup();
    }

    // 내부 호출용 상태 업데이트 함수 (페이지 리로드 방지)
    async function updateSiteStatusInternal(ucode, siteNum, status) {
        try {
            const response = await fetch('/update_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usercode: ucode, site_number: siteNum, new_status: status })
            });
            if (!response.ok) throw new Error('Internal site status update failed');
            console.log(`Site ${siteNum} status updated to ${status} internally.`);
        } catch (error) { console.error('Internal site status update error:', error); }
    }

    async function updateRouteStatusInternal(ucode, routeNum, status) {
        try {
            const response = await fetch('/update_route_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usercode: ucode, route_number: routeNum, new_status: status })
            });
            if (!response.ok) throw new Error('Internal route status update failed');
            console.log(`Route ${routeNum} status updated to ${status} internally.`);
        } catch (error) { console.error('Internal route status update error:', error); }
    }


    function initializeMap() {
        const cityCoordinates = {
            "서울": { lat: 37.5665, lng: 126.9780 },
            "청주": { lat: 36.6424341, lng: 127.4890319 },
            "부산": { lat: 35.1796, lng: 129.0756 },
            "제주": { lat: 33.4996, lng: 126.5312 }
        };

        let mapCenterCity = "서울"; // 기본값
        if (touristSites && touristSites.length > 0 && touristSites[0] && touristSites[0].address) {
            const firstSiteAddress = touristSites[0].address;
            for (const cityName in cityCoordinates) {
                if (firstSiteAddress.includes(cityName)) {
                    mapCenterCity = cityName;
                    break;
                }
            }
        }
        city = mapCenterCity; // 전역 city 변수 업데이트

        const center = cityCoordinates[city];
        map = new Tmapv2.Map("map", {
            center: new Tmapv2.LatLng(center.lat, center.lng),
            width: "100%",
            height: "500px",
            zoom: 12
        });
        infoWindow = new Tmapv2.InfoWindow({
            position: new Tmapv2.LatLng(0, 0),
            border : '0px solid #FF0000',
            background : "rgba(255,255,255,0.8)",
            content: "<div style='padding:5px; font-size:12px;'>Test</div>",
            visible : false,
            map: map
        });
    }

    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
    }

    function updateMapMarkers() {
        if (!tmapLoaded) {
            console.warn("Tmap API가 아직 로드되지 않았습니다. 마커 업데이트를 연기합니다.");
            return;
        }
        clearMarkers();
        touristSites.forEach((site, index) => {
            if (site && site.mapy && site.mapx) { // site가 null이 아니고, mapy, mapx가 있는지 확인
               let markerIconUrl;
                if (index === 0) markerIconUrl = startIcon;
                else if (index === touristSites.length - 1) markerIconUrl = endIcon;
                else markerIconUrl = middleIcon;

                const lonLat = new Tmapv2.LatLng(site.mapy, site.mapx);
                const marker = new Tmapv2.Marker({
                    position: lonLat,
                    icon: markerIconUrl,
                    iconSize: new Tmapv2.Size(65, 30), //
                    title: site.name,
                    map: map
                });
                markers.push(marker);
            } else {
                console.error(`유효하지 않은 위치 정보 또는 null인 관광지: index ${index}`);
            }
        });
        if (markers.length > 0) {
            const bounds = new Tmapv2.LatLngBounds();
            markers.forEach(marker => bounds.extend(marker.getPosition()));
            if (touristSites.filter(s => s !== null).length === 1 && markers[0]) { // null이 아닌 관광지가 하나일 때
                map.setCenter(markers[0].getPosition());
                map.setZoom(15);
            } else {
                map.fitBounds(bounds);
            }
        }
    }

    function getTmapPath() {
        if (!tmapLoaded) {
            console.warn("Tmap API가 아직 로드되지 않았습니다. 경로 요청을 연기합니다.");
            return;
        }
        clearPolylines();
        const validSites = touristSites.filter(site => site && site.mapx && site.mapy);
        if (validSites.length < 2) return;

        for (let i = 0; i < validSites.length - 1; i++) {
            const startPoint = validSites[i];
            const endPoint = validSites[i + 1];

            $.ajax({
                method: "POST",
                url: "https://apis.openapi.sk.com/tmap/routes/pedestrian?version=1&format=json", //
                headers: { "Accept": "application/json", "Content-Type": "application/json; charset=utf-8", "appKey": apiKey },
                data: JSON.stringify({
                    startX: startPoint.mapx, startY: startPoint.mapy,
                    endX: endPoint.mapx, endY: endPoint.mapy,
                    reqCoordType: "WGS84GEO", resCoordType: "WGS84GEO", //
                    startName: startPoint.name, endName: endPoint.name
                }),
                success: function (response) { drawTmapPath(response.features); },
                error: function (request, status, error) { console.error("경로 요청 실패:", error, request.responseText); }
            });
        }
    }

    function drawTmapPath(pathData) {
        if (!pathData) return;
        pathData.forEach(feature => {
            if (feature.geometry.type === "LineString") {
                const line = new Tmapv2.Polyline({
                    path: feature.geometry.coordinates.map(coord => new Tmapv2.LatLng(coord[1], coord[0])),
                    strokeColor: "#DD0000", strokeWeight: 6, map: map //
                });
                polylines.push(line);
            }
        });
    }

    function clearPolylines() { polylines.forEach(p => p.setMap(null)); polylines = []; }

    function completeAll() {
        document.getElementById('confirmCompletePopup').style.display = 'block';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function tmapApiLoaded() {
        console.log("Tmapv2 API 로드 완료");
        tmapLoaded = true;
        init();
    }
    window.tmapApiLoaded = tmapApiLoaded;

    function init() {
        if (typeof Tmapv2 !== 'undefined' && Tmapv2.Map) {
            initializeMap();
            updateMapMarkers();
            if (touristSites.filter(s => s !== null).length > 1) getTmapPath();
        } else {
            console.error("Tmapv2 API 스크립트 로드 실패 또는 Tmapv2.Map 정의 안됨");
            // jQuery $(document).ready()에서 이미 로딩 재시도 로직이 있을 수 있음
        }
    }

    function onError(error) { // 현재 사용되지 않지만, TMAP 에러 콜백 등으로 활용 가능
        alert("오류가 발생했습니다: " + error);
        console.error("오류:", error);
    }

    function openMissionPopup() {
        const missionPopupContainer = $("#missionPopupContainer");
        if (missionPopupContainer.css('display') !== 'none') {
            return;
        }

        const buttonEl = $("#dragM");
        const buttonRect = buttonEl[0].getBoundingClientRect();
        const popupWidth = missionPopupContainer.outerWidth();
        const popupHeight = missionPopupContainer.outerHeight();

        const gap = 10;
        const screenMargin = 5;

        const viewportWidth = $(window).width();
        const viewportHeight = $(window).height();

        let targetLeft = buttonRect.left - popupWidth - gap;
        let targetTop = buttonRect.top;

        if (targetLeft < screenMargin) {
            targetLeft = buttonRect.right + gap;
            if (targetLeft + popupWidth > viewportWidth - screenMargin) {
                targetLeft = viewportWidth - popupWidth - screenMargin;
            }
        }

        if (targetLeft < screenMargin) {
            targetLeft = screenMargin;
        }

        targetTop = Math.max(screenMargin, targetTop);
        if (targetTop + popupHeight > viewportHeight - screenMargin) {
            targetTop = viewportHeight - popupHeight - screenMargin;
            if (targetTop < screenMargin) {
                targetTop = screenMargin;
            }
        }

        missionPopupContainer.css({
            left: targetLeft + 'px',
            top: targetTop + 'px',
            display: 'block'
        });
        $("#missionPopup").attr("src", `/mission?usercode=${usercode}`);

        if (!isMissionPopupOpen) {
            history.pushState({ missionPopup: "open" }, "Mission Popup", "#missionOpen");
            isMissionPopupOpen = true;
        }
    }

    function closeMissionPopup(isFromPopState = false) {
        $("#missionPopupContainer").css("display", "none");
        $("#missionPopup").attr("src", "about:blank");

        if (isMissionPopupOpen) {
            if (!isFromPopState && history.state && history.state.missionPopup === "open") {
                history.back();
            } else {
                 isMissionPopupOpen = false;
            }
        }
    }

    window.addEventListener('popstate', function(event) {
        if (isMissionPopupOpen) {
            if (!event.state || !event.state.missionPopup) {
                closeMissionPopup(true);
            }
        }
    });

    $(document).ready(function () {
        const checkTmapAndInit = () => {
            if (typeof Tmapv2 !== 'undefined' && Tmapv2.Map && tmapLoaded) {
                init();
                 // 첫 번째 관광지 상태를 '진행 중'으로 설정 (최초 1회)
                if (touristSites && touristSites.length > 0 && touristSites[0] !== null && statuses[0] === 0) {
                    const firstSiteProcessedKey = `firstSiteProcessed_${usercode}`;
                    if (!localStorage.getItem(firstSiteProcessedKey)) {
                        // updateStatus 함수를 직접 호출하기보다는, 백엔드에 상태 변경 요청 후 리로드
                        fetch('/update_status', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({usercode: usercode, site_number: 1, new_status: 2})
                        }).then(response => response.json())
                          .then(data => {
                              if(data.status === 'success') {
                                  localStorage.setItem(firstSiteProcessedKey, 'true');
                                  location.reload();
                              } else {
                                  console.error("첫 관광지 상태 변경 실패:", data.message);
                              }
                          }).catch(error => console.error("첫 관광지 상태 변경 요청 오류:", error));
                    }
                }

            } else {
                setTimeout(checkTmapAndInit, 100); // 0.1초 후 다시 확인
            }
        };
        checkTmapAndInit();


      $("#dragM").draggable({
            containment: "#map", // 부모 요소인 #map 안으로 제한
            start: function(event, ui) {
                // dragOffsetDiff는 문서 기준 offset으로 계산합니다. (기존과 동일)
                const buttonDocPos = $(this).offset();
                const popupDocPos = $("#missionPopupContainer").offset();
                dragOffsetDiff = {
                    left: popupDocPos.left - buttonDocPos.left,
                    top: popupDocPos.top - buttonDocPos.top
                };
            },
            drag: function(event, ui) {
                // ui.offset은 #dragM의 새로운 문서 기준 offset입니다.
                let targetPopupDocLeft = ui.offset.left + dragOffsetDiff.left;
                let targetPopupDocTop = ui.offset.top + dragOffsetDiff.top;

                // fixed인 미션 창의 CSS top/left는 뷰포트 기준입니다.
                // 문서 좌표를 뷰포트 좌표로 변환합니다.
                let popupViewportLeft = targetPopupDocLeft - $(window).scrollLeft();
                let popupViewportTop = targetPopupDocTop - $(window).scrollTop();

                $("#missionPopupContainer").css({
                    left: popupViewportLeft + 'px',
                    top: popupViewportTop + 'px'
                });
            },
            stop: function(event, ui) { // 드래그 종료 시
                // drag 이벤트와 동일한 로직으로 최종 위치를 한 번 더 동기화합니다.
                let targetPopupDocLeft = ui.offset.left + dragOffsetDiff.left;
                let targetPopupDocTop = ui.offset.top + dragOffsetDiff.top;

                let popupViewportLeft = targetPopupDocLeft - $(window).scrollLeft();
                let popupViewportTop = targetPopupDocTop - $(window).scrollTop();

                $("#missionPopupContainer").css({
                    left: popupViewportLeft + 'px',
                    top: popupViewportTop + 'px'
                });
            }
        });
        $("#missionPopupContainer").draggable({
            containment: "window",
            handle: "#missionPopupContainer", // 팝업창 아무데나 눌러도 드래그 되도록
            start: function(event, ui) {
                const popupPos = $(this).offset(); // 팝업의 현재 document offset
                const buttonPos = $("#dragM").offset(); // 버튼의 현재 document offset
                dragOffsetDiff = {
                    left: buttonPos.left - popupPos.left,
                    top: buttonPos.top - popupPos.top
                };
            },
            drag: function(event, ui) {
                // ui.offset은 팝업의 새 document offset
                // #dragM (absolute)은 .offset()으로 위치 설정
                 $("#dragM").offset({
                    left: ui.offset.left + dragOffsetDiff.left,
                    top: ui.offset.top + dragOffsetDiff.top
                });
            }
        });

        let isDraggingM = false;
        $("#dragM").on("dragstart", function() {
            isDraggingM = true;
        });
        $("#dragM").on("dragstop", function() {
            setTimeout(() => { isDraggingM = false; }, 50);
        });

        $(document).on('click', '#dragM', function(event) {
            if (!isDraggingM) {
                openMissionPopup();
            }
        });

        function updateDestinationInfo() { // 현재 HTML 구조에 #destinationInfo 요소가 없으므로 주석 처리
            // let currentSiteIndex = statuses.findIndex(status => status === 2);
            // let nextSite;
            // let progress;
            // ... (로직은 유효하나, 표시할 대상이 없음) ...
            // if (nextSite) {
            //     let infoText = `목적지: ${nextSite.name} (${progress}/${touristSites.length})`;
            //     $("#destinationInfo").text(infoText);
            // }
        }
        updateDestinationInfo(); // 호출은 유지 (나중에 해당 ID 요소 추가 시 작동하도록)
    });

    function copyUserCode() {
        const userCodeText = '{{ usercode }}';
        navigator.clipboard.writeText(userCodeText).then(() => {
            showToastMessage('User Code가 복사되었습니다!');
        }).catch(err => {
            console.error('복사 실패:', err);
            showToastMessage('복사에 실패했습니다.');
        });
    }

    function showToastMessage(message) {
        const toast = document.getElementById('toastMessage');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 2000);
    }
    function confirmReview() { window.location.href = '/review/' + usercode; }
    function acknowledgeComplete() { window.location.href = '/finished'; }
</script>
</body>
</html>