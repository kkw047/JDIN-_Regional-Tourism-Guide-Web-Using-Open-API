<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 여행 현황</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
        color: #343a40;
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #eee;
    }

    #map {
        width: 100%;
        height: 500px;
        background-color: #dcdcdc;
        border: 1px solid #ccc;
        margin-bottom: 20px;
        border-radius: 8px;
        position: relative;
        margin-bottom: 40px;
    }

    .map-footer {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 2;
    }

    .user-code {
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        font-size: 14px;
        z-index: 2;
        cursor: pointer; /* 복사 가능하도록 커서 변경 */
    }

    .destination-info {
        text-align: center;
        font-size: 18px;
        font-weight: bold;
    }

    .site-list {
        list-style: none;
        padding: 0;
    }

    .site-item {
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
    }

    .grid-container {
        display: grid;
        grid-template-columns: 30% auto ;
        grid-gap: 10px;
        align-items: center;
    }

    .site-info { /* 이 클래스는 site-name-box의 컨테이너 역할 */
        text-align: center; /* 내부 site-name-box 정렬에 영향은 없음 */
        position: relative; /* site-name-box의 absolute 위치 기준 */
        height: 10px; /* site-name-box가 여기에 걸쳐 보이도록 높이 조정 */
    }
    .site-name-box {
        position: absolute;
        left: 50%; /* grid-container의 첫 번째 컬럼(30%)의 중앙으로 변경 */
        transform: translateX(-50%) translateY(-23px);
        white-space: nowrap;
        text-align: center;
        font-size: 24px;
        font-weight: 600;
        color: #3b3b3b;
        background-color: #ffffff;
        border-radius: 8px;
        border: 2px solid #ffffff; /* 배경색과 동일하게 하여 테두리 없는 효과 */
        padding: 5px 13px;
    }

    .site-button {
        text-align: left;
    }

    .arrow-row {
        text-align: center;  /* 내부 arrow 정렬에 영향 */
        position: relative; /* arrow의 absolute 위치 기준 */
        height: 10px; /* arrow가 여기에 걸쳐 보이도록 높이 조정 */
    }

    .route-button {
        text-align: left;
    }

    .arrow {
        position: absolute;
        left: 50%; /* grid-container의 첫 번째 컬럼(30%)의 중앙으로 변경 */
        transform: translateX(-50%) translateY(-25px); /* Y 위치 조정됨 */
        font-size: 38px;
        transition: transform 0.3s ease-in-out;
        animation: none;
    }

    @keyframes upDown {
        0%, 100% {
            transform: translateX(-50%) translateY(-25px);
        }
        50% {
            transform: translateX(-50%) translateY(-20px);
        }
    }

    .arrow.blinking {
        animation: upDown 1s infinite;
    }

    .status-button {
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 83px;
        font-size: 18px;
        line-height: 42px;
        margin-bottom: 5px;
        margin-top: 5px;
        margin-left: 60%;
        text-align: center;
        padding: 0;
    }

    .popup-button-group {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin-top: 20px; /* 메시지와의 간격 */
        margin-bottom: 10px; /* 팝업 하단과의 간격 */
    }

    .popup-button-group button {
        font-size: 16px;
        min-width: 70px;
        height: 36px;
        padding: 6px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        color: white;
        font-weight: bold;
        line-height: 1;
    }

    .status-button.waiting {
        background-color: #dc3545;
    }

    .status-button.in-progress {
        background-color: #007bff;
    }

    .status-button.completed {
        background-color: #28a745;
    }

    .status-button.waiting.blinking,
    .status-button.in-progress.blinking {
        animation: blinker 1s linear infinite;
    }

    @keyframes blinker {
        50% {
            opacity: 0.5;
        }
    }

    .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px 25px; /* 패딩 조정 */
        border: 1px solid #ccc;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        width: 320px;
        border-radius: 8px; /* 모서리 둥글게 */
        /* align-items, justify-content 제거 (내부 p, button-group으로 정렬) */
        font-size: 20px;
        text-align: center;
    }
    .popup h2 {
        font-size: 22px; /* 팝업 제목 크기 */
        margin-top: 0;
        margin-bottom: 15px;
    }
    .popup p {
        margin-bottom: 20px; /* 메시지와 버튼 그룹 사이 간격 */
        font-size: 18px; /* 메시지 폰트 크기 */
        line-height: 1.5;
    }


    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }

    .tmap-marker img {
        width: 65px;
        height: 30px;
    }

    .complete-button-container {
        text-align: center;
        margin-top: 20px;

    }

    .complete-button {
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        background-color: #28a745;
        transition: background-color 0.3s;
        font-size: 22px;
    }

    .complete-button:hover {
        background-color: #218838;
    }

    #dragM { /* 미션 버튼 */
        position: absolute;
        top: 10px;
        left: 10px;
        width: 50px;
        height: 50px;
        background-image: url('/static/m_icon.png');
        background-size: cover;
        cursor: grab; /* 드래그 가능함을 나타내는 커서 */
        z-index: 1000;
    }
    #dragM:active {
        cursor: grabbing; /* 드래그 중 커서 변경 */
    }


    #missionPopupContainer { /* 미션 팝업 창 */
        position: fixed;
        /* top, left는 JavaScript에서 설정하므로 초기값은 불필요하거나 간단히 설정 */
        width: 400px;
        height: 75%;
        max-height: 750px;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1001; /* 미션 버튼보다 위에 오도록 */
        display: none;
        border-radius: 8px;
        overflow: hidden;
        cursor: move; /* 창 자체도 드래그 가능함을 표시 */
    }
    #missionPopupContainer:active {
        cursor: grabbing;
    }


    #missionPopup { /* 미션 내용 iframe */
        width: 100%;
        height: 100%;
        border: none;
    }

    #closeButton { /* 미션 팝업 닫기 버튼 */
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1002; /* iframe 위에 오도록 */
        font-size: 14px;
        line-height: 1;
    }
    #closeButton:hover {
        background-color: #c0392b;
    }

    .toast-message {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s, bottom 0.3s;
        pointer-events: none;
    }

    @keyframes markerBlink {
        0%, 100% { opacity: 1.3; }
        50% { opacity: 0.5; }
    }

    .marker-blinking {
        animation: markerBlink 1s infinite;
    }

    .toast-message.show {
        opacity: 1;
        bottom: 30px;
    }

</style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=Mb9cttQ9De2UcPzNfNwCl7ZRY31kNiUqPjCAeZne&callback=tmapApiLoaded"></script>
</head>

<body>
    <div class="container">
        <h1>실시간 여행 현황</h1>
        <div id="map">
            <div id="dragM"></div>
            <div class="map-footer">
                <div class="user-code" onclick="copyUserCode()">User Code: {{ usercode }}</div>
            </div>
        </div>

        <ul class="site-list">
    {% for i in range(count) %}
    <li class="site-item">
        <div class="grid-container">
            <div class="site-info">
                {% if tourist_sites[i] %}
                <div class="site-name-box">{{ tourist_sites[i].name }}</div>
                {% endif %}
            </div>
            <div class="site-button">
                {% if statuses[i] == 0 %}
                    {% if i == 0 or (statuses[i-1] == 1 and (i == 1 or (routes[i-1] and routes[i-1].status == 1))) %}
                        <button class="status-button waiting" onclick="openPopup('site', '{{ usercode }}', {{ i + 1 }}, 2)">대기</button>
                    {% else %}
                        <button class="status-button waiting" disabled>대기</button>
                    {% endif %}
                {% elif statuses[i] == 2 %}
                    <button class="status-button in-progress blinking" onclick="openCompletePopup('{{ usercode }}', {{ i + 1 }})">진행중</button>
                {% elif statuses[i] == 1 %}
                    <button class="status-button completed" onclick="openCancelPopup('site', '{{ usercode }}', {{ i + 1 }})">완료</button>
                {% endif %}
            </div>

            {% if i < count - 1 and routes[i] %}
            <div class="arrow-row">
                <div class="arrow {% if routes[i].status == 2 %}blinking{% endif %}">↓</div>
            </div>
            <div class="route-button">
                {% if routes[i].status == 0 %}
                    {% if statuses[i] == 1 %}
                        <button class="status-button waiting" onclick="openPopup('route', '{{ usercode }}', {{ i + 1 }}, 2)">대기</button>
                    {% else %}
                        <button class="status-button waiting" disabled>대기</button>
                    {% endif %}
                {% elif routes[i].status == 2 %}
                    <button class="status-button in-progress blinking" onclick="openPopup('route', '{{ usercode }}', {{ i + 1 }}, 1)">진행중</button>
                {% elif routes[i].status == 1 %}
                    <button class="status-button completed" onclick="openCancelPopup('route', '{{ usercode }}', {{ i + 1 }})">완료</button>
                {% endif %}
            </div>
            {% elif i < count - 1 and not routes[i] %} {# routes[i]가 없는 경우 (데이터 오류 등) #}
            <div class="arrow-row">
                <div class="arrow">↓</div> {# 깜빡임 없이 기본 화살표 #}
            </div>
            <div class="route-button">
                 <button class="status-button waiting" disabled>경로 정보 없음</button>
            </div>
            {% endif %}
        </div>
    </li>
    {% endfor %}
</ul>

        {% if statuses and statuses|length > 0 and statuses[-1] == 1 %}
        <div class="complete-button-container">
            <button class="complete-button" onclick="completeAll()">여행 완료</button>
        </div>
        {% endif %}

        <div class="popup" id="statusPopup">
            <h2 id="statusPopupTitle">상태 변경</h2> <p id="popupMessage"></p>
            <div class="popup-button-group">
                <button onclick="updateStatus()" style="background-color: #28a745;">예</button>
                <button onclick="closePopup()" style ="background-color: #dc3545;">아니오</button>
            </div>
        </div>

        <div class="popup" id="cancelPopup" >
            <h2>취소 확인</h2>
            <p>취소하시겠습니까?</p>
            <div class="popup-button-group">
                <button onclick="cancelStatus()" style="background-color: #28a745;">예</button>
                <button onclick="closePopup()" style ="background-color: #dc3545;">아니오</button>
            </div>
        </div>

        <div class="popup" id="completePopup" >
            <h2 id="completePopupTitle">여행 완료</h2> <p id="completePopupMessage">여행을 완료하셨습니까?</p>
            <div class="popup-button-group">
            <button onclick="completeStatus()" style="background-color: #28a745;">예</button>
            <button onclick="closePopup()" style ="background-color: #dc3545; ">아니오</button>
            </div>
        </div>

        <div class="popup" id="confirmCompletePopup" style="min-width: 400px;">
            <h2>모든 여행이 완료되었습니다!</h2>
            <p>후기를 작성하시겠습니까?</p>
            <div class="popup-button-group">
                <button onclick="confirmReview()" style="background-color: #28a745;">예</button>
                <button onclick="acknowledgeComplete()" style="background-color: #dc3545;">아니오</button>
                <button onclick="closePopup()" style="background-color: #6c757d; margin-left: 40px;">닫기</button>
            </div>
        </div>

        <div class="overlay" id="popupOverlay"></div>

        <div id="missionPopupContainer">
            <button id="closeButton" onclick="closeMissionPopup()">닫기</button>
            <iframe id="missionPopup" src="about:blank" ></iframe>
        </div>
        <div id="toastMessage" class="toast-message"></div>
    </div>

<script>
    let map;
    let markers = [];
    let polylines = [];
    let usercode = '{{ usercode }}';
    let currentType = '';
    let currentUsercode = '{{ usercode }}'; // usercode로 초기화
    let currentNumber = 0;
    let newStatus = 0; // 정수형으로 초기화
    let touristSites = {{ tourist_sites | tojson }};
    let statuses = {{ statuses | tojson }};
    let routes = {{ routes | tojson }};
    let tmapLoaded = false;
    let infoWindow;
    const apiKey = "Mb9cttQ9De2UcPzNfNwCl7ZRY31kNiUqPjCAeZne";
    const startIcon = "/static/start.png";
    const middleIcon = "/static/middle.png";
    const endIcon = "/static/end.png";
    let city = "서울"; // 기본값

    // --- 미션 팝업 관련 전역 변수 ---
    let isMissionPopupOpen = false;
    let dragOffsetDiff = { left: 0, top: 0 };
    let isDraggingM = false; // #dragM 드래그 상태 플래그

    function openPopup(type, code, number, status) {
        console.log("openPopup 호출", type, code, number, status);
        currentType = type;
        currentUsercode = code;
        currentNumber = number;
        newStatus = status;

        let popupMessage = "";
        let popupTitle = "상태 변경 확인";

        if (type === 'site') {
            const siteName = touristSites[number-1] ? touristSites[number-1].name : `관광지 ${number}`;
            if (statuses[number - 1] === 0) {
                popupMessage = `"${siteName}" 여행을 시작하시겠습니까?`;
                popupTitle = "여행 시작";
            } else if (statuses[number - 1] === 1) { // 완료 상태 클릭 시 취소 팝업
                openCancelPopup(type, code, number);
                return;
            }
        } else if (type === 'route') {
            const routeDesc = (touristSites[number-1] && touristSites[number]) ?
                              `"${touristSites[number-1].name}"에서 "${touristSites[number].name}"로의 경로` :
                              `경로 ${number}`;
            if (routes[number - 1].status === 0) {
                popupMessage = `${routeDesc} 이동을 시작하시겠습니까?`;
                popupTitle = "경로 시작";
            } else if (routes[number - 1].status === 2){
                popupMessage = `${routeDesc} 이동을 완료하시겠습니까?`;
                popupTitle = "경로 완료";
            } else if (routes[number-1].status === 1) { // 완료 상태 클릭 시 취소 팝업
                openCancelPopup(type, code, number);
                return;
            }
        }
        document.getElementById('popupMessage').innerText = popupMessage;
        document.getElementById('statusPopupTitle').innerText = popupTitle; // 제목 설정

        document.getElementById('statusPopup').style.display = 'block';
        document.getElementById('cancelPopup').style.display = 'none';
        document.getElementById('completePopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function openCompletePopup(code, number) {
        console.log("openCompletePopup 호출", code, number);
        currentUsercode = code;
        currentNumber = number;
        const siteName = touristSites[number-1] ? touristSites[number-1].name : `관광지 ${number}`;
        document.getElementById('completePopupMessage').innerText = `"${siteName}" 여행을 완료하시겠습니까?`;
        document.getElementById('completePopupTitle').innerText = `"${siteName}" 완료`; // 제목 설정

        document.getElementById('statusPopup').style.display = 'none';
        document.getElementById('cancelPopup').style.display = 'none';
        document.getElementById('completePopup').style.display = 'block';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function openCancelPopup(type, code, number) {
        console.log("openCancelPopup 호출", type, code, number);
        currentType = type;
        currentUsercode = code;
        currentNumber = number;

        document.getElementById('statusPopup').style.display = 'none';
        document.getElementById('cancelPopup').style.display = 'block';
        document.getElementById('completePopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function closePopup() {
        document.getElementById('statusPopup').style.display = 'none';
        document.getElementById('cancelPopup').style.display = 'none';
        document.getElementById('completePopup').style.display = 'none';
        document.getElementById('confirmCompletePopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'none';
    }

    async function updateStatus() {
        let url = '';
        let data = { usercode: currentUsercode, new_status: newStatus };

        if (currentType === 'site') {
            url = '/update_status';
            data.site_number = currentNumber;
        } else if (currentType === 'route') {
            url = '/update_route_status';
            data.route_number = currentNumber;
        } else {
            closePopup(); return;
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error('Network response was not ok');
            const result = await response.json();
            if (result.status === 'success') location.reload();
            else alert('상태 업데이트 실패: ' + result.message);
        } catch (error) {
            console.error('Error:', error);
            alert('상태 업데이트 중 오류 발생');
        }
        closePopup();
    }

    async function completeStatus() { // 관광지 완료 시
        try {
            const response = await fetch('/update_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    usercode: currentUsercode,
                    site_number: currentNumber,
                    new_status: 1 // 완료
                })
            });
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            if (data.status === 'success') location.reload();
            else alert('상태 업데이트 실패: ' + data.message);
        } catch (error) {
            console.error('Error:', error);
            alert('상태 업데이트 중 오류 발생');
        }
        closePopup();
    }

    async function cancelStatus() {
        const dataToCancel = { usercode: currentUsercode, item_type: currentType, item_number: currentNumber };
        try {
            const response = await fetch('/update_cancel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToCancel)
            });
            if (!response.ok) throw new Error('Network response was not ok');
            const result = await response.json();
            if (result.status === 'success') location.reload();
            else alert('상태 취소 실패: ' + result.message);
        } catch (error) {
            console.error('Error:', error);
            alert('상태 취소 중 오류 발생');
        }
        closePopup();
    }

    // 페이지 로드 시 첫 번째 관광지를 '진행중'(2)으로 설정하는 로직은 $(document).ready()로 이동.

    function initializeMap() {
        const cityCoordinates = {
            "서울": { lat: 37.5665, lng: 126.9780 },
            "청주": { lat: 36.6424341, lng: 127.4890319 },
            "부산": { lat: 35.1796, lng: 129.0756 },
            "제주": { lat: 33.4996, lng: 126.5312 }
        };
        let mapCenterCity = "서울";
        if (touristSites && touristSites.length > 0 && touristSites[0] && touristSites[0].address) {
            const firstSiteAddress = touristSites[0].address;
            for (const cityNameKey in cityCoordinates) {
                if (firstSiteAddress.includes(cityNameKey)) {
                    mapCenterCity = cityNameKey;
                    break;
                }
            }
        }
        city = mapCenterCity;
        const center = cityCoordinates[city];
        map = new Tmapv2.Map("map", { center: new Tmapv2.LatLng(center.lat, center.lng), width: "100%", height: "500px", zoom: 12 });
        // infoWindow 초기화는 필요 시 추가
    }

    function clearMarkers() { markers.forEach(marker => marker.setMap(null)); markers = []; }

    function updateMapMarkers() {
        if (!tmapLoaded) return;
        clearMarkers();
        touristSites.forEach((site, index) => {
            if (site && site.mapy && site.mapx) {
               let markerIcon = (index === 0) ? startIcon : (index === touristSites.length - 1) ? endIcon : middleIcon;
               const lonLat = new Tmapv2.LatLng(site.mapy, site.mapx);
               const marker = new Tmapv2.Marker({ position: lonLat, icon: markerIcon, iconSize: new Tmapv2.Size(65, 30), title: site.name, map: map });
               if (statuses[index] === 2) { // 진행중 상태 마커 깜빡임
                   const el = marker.getElement();
                   if (el) el.classList.add('marker-blinking');
               }
               markers.push(marker);
            }
        });
        if (markers.length > 0) {
            const bounds = new Tmapv2.LatLngBounds();
            markers.forEach(marker => bounds.extend(marker.getPosition()));
            if (touristSites.filter(s => s != null).length === 1) {
                map.setCenter(markers[0].getPosition()); map.setZoom(15);
            } else {
                map.fitBounds(bounds);
            }
        }
    }

    function getTmapPath() {
        if (!tmapLoaded) return;
        clearPolylines();
        const validSites = touristSites.filter(site => site && site.mapx && site.mapy);
        if (validSites.length < 2) return;

        let promises = [];
        for (let i = 0; i < validSites.length - 1; i++) {
            const startPoint = validSites[i], endPoint = validSites[i + 1];
            const requestData = {
                startX: startPoint.mapx, startY: startPoint.mapy, endX: endPoint.mapx, endY: endPoint.mapy,
                reqCoordType: "WGS84GEO", resCoordType: "WGS84GEO", startName: startPoint.name, endName: endPoint.name
            };
            promises.push($.ajax({
                method: "POST", url: "https://apis.openapi.sk.com/tmap/routes/pedestrian?version=1&format=json",
                headers: { "Accept": "application/json", "Content-Type": "application/json; charset=utf-8", "appKey": apiKey },
                data: JSON.stringify(requestData)
            }));
        }
        Promise.all(promises)
            .then(results => {
                results.forEach((response, index) => {
                    if (response && response.features) {
                        let color = "#DD0000"; // 기본 빨강
                        if (routes[index] && routes[index].status === 2) color = "#007bff"; // 진행중 파랑
                        else if (routes[index] && routes[index].status === 1) color = "#28a745"; // 완료 초록
                        drawTmapPath(response.features, color);
                    }
                });
            }).catch(error => console.error("경로 요청 실패:", error));
    }

    function drawTmapPath(pathData, color = "#DD0000") {
        if (!pathData) return;
        pathData.forEach(feature => {
            if (feature.geometry.type === "LineString") {
                const line = new Tmapv2.Polyline({
                    path: feature.geometry.coordinates.map(coord => new Tmapv2.LatLng(coord[1], coord[0])),
                    strokeColor: color, strokeWeight: 6, map: map
                });
                polylines.push(line);
            }
        });
    }
    function clearPolylines() { polylines.forEach(p => p.setMap(null)); polylines = []; }
    function completeAll() {
        document.getElementById('confirmCompletePopup').style.display = 'block';
        document.getElementById('popupOverlay').style.display = 'block';
    }
    function tmapApiLoaded() { console.log("Tmapv2 API 로드 완료"); tmapLoaded = true; init(); }
    window.tmapApiLoaded = tmapApiLoaded; // 전역으로 노출
    function init() {
        if (typeof Tmapv2 !== 'undefined' && Tmapv2.Map) {
            initializeMap();
            updateMapMarkers();
            if (touristSites.filter(s => s != null).length > 1) getTmapPath();
        } else {
            setTimeout(init, 100); // TMAP 로드될 때까지 재시도
        }
    }
    function onError(error) { alert("오류: " + error); console.error("오류:", error); }

    // --- 미션 팝업 창 관련 기능 ---
    function openMissionPopup() {
        const missionPopupContainer = $("#missionPopupContainer");
        if (missionPopupContainer.css('display') !== 'none') {
            return; // 이미 열려있으면 중복 실행 방지
        }

        const buttonEl = $("#dragM");
        const buttonRect = buttonEl[0].getBoundingClientRect();
        const popupWidth = missionPopupContainer.outerWidth();
        const popupHeight = missionPopupContainer.outerHeight();

        const gap = 10;
        const screenMargin = 5;

        const viewportWidth = $(window).width();
        const viewportHeight = $(window).height();

        let targetLeft = buttonRect.left - popupWidth - gap; // 버튼 왼쪽에 위치
        let targetTop = buttonRect.top; // 버튼 상단에 정렬

        // 화면 왼쪽 경계 체크
        if (targetLeft < screenMargin) {
            targetLeft = buttonRect.right + gap; // 왼쪽에 공간 없으면 오른쪽에 시도
            // 오른쪽으로 옮겼는데도 화면 오른쪽 벗어나면
            if (targetLeft + popupWidth > viewportWidth - screenMargin) {
                targetLeft = viewportWidth - popupWidth - screenMargin; // 오른쪽 가장자리에 맞춤
            }
        }
        // 최종적으로 화면 왼쪽 벗어나는 것 방지
        if (targetLeft < screenMargin) {
            targetLeft = screenMargin;
        }

        // 화면 상하단 경계 체크
        targetTop = Math.max(screenMargin, targetTop);
        if (targetTop + popupHeight > viewportHeight - screenMargin) {
            targetTop = viewportHeight - popupHeight - screenMargin;
            if (targetTop < screenMargin) { // 팝업이 화면보다 클 경우
                targetTop = screenMargin;
            }
        }

        missionPopupContainer.css({
            left: targetLeft + 'px',
            top: targetTop + 'px',
            display: 'block'
        });
        if (usercode) { // usercode가 정의되었는지 확인
             $("#missionPopup").attr("src", `/mission?usercode=${usercode}`);
        } else {
            console.error("openMissionPopup: usercode is not defined!");
            // 사용자에게 알림 또는 대체 동작
        }


        if (!isMissionPopupOpen) {
            history.pushState({ missionPopup: "open" }, "Mission Popup", "#missionOpen");
            isMissionPopupOpen = true;
        }
    }

    function closeMissionPopup(isFromPopState = false) {
        $("#missionPopupContainer").css("display", "none");
        $("#missionPopup").attr("src", "about:blank");

        const wasPopupOpen = isMissionPopupOpen;
        isMissionPopupOpen = false;

        if (!isFromPopState && wasPopupOpen) {
            if (history.state && history.state.missionPopup === "open") {
                history.back();
            }
        }
    }

    window.addEventListener('popstate', function(event) {
        if (event.state && event.state.missionPopup === "open") {
            if (!isMissionPopupOpen) {
                $("#missionPopupContainer").css("display", "block");
                if (usercode) { // usercode 확인
                     $("#missionPopup").attr("src", `/mission?usercode=${usercode}`);
                }
                isMissionPopupOpen = true;
            }
        } else {
            if (isMissionPopupOpen) {
                $("#missionPopupContainer").css("display", "none");
                $("#missionPopup").attr("src", "about:blank");
                isMissionPopupOpen = false;
            }
        }
    });

    $(document).ready(function () {
        // init(); // tmapApiLoaded 콜백에서 init()이 호출되므로 중복 호출 방지
        const checkTmapAndInit = () => {
            if (typeof Tmapv2 !== 'undefined' && Tmapv2.Map && tmapLoaded) {
                init();
                // 첫 번째 관광지 상태를 '진행 중'(2)으로 최초 1회 설정
                if (touristSites && touristSites.length > 0 && touristSites[0] !== null && statuses[0] === 0) {
                    const firstSiteProcessedKey = `firstSiteProcessed_${usercode}`;
                    if (!localStorage.getItem(firstSiteProcessedKey)) {
                        fetch('/update_status', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({usercode: usercode, site_number: 1, new_status: 2})
                        }).then(response => response.json())
                          .then(data => {
                              if(data.status === 'success') {
                                  localStorage.setItem(firstSiteProcessedKey, 'true');
                                  location.reload();
                              } else { console.error("첫 관광지 상태 변경 실패:", data.message); }
                          }).catch(error => console.error("첫 관광지 상태 변경 요청 오류:", error));
                    }
                }
            } else { setTimeout(checkTmapAndInit, 100); }
        };
        if (!tmapLoaded) { // TMAP API가 $(document).ready() 보다 늦게 로드될 경우 대비
            checkTmapAndInit();
        }


        $("#dragM").on("dragstart", function() {
            isDraggingM = true;
        });
        $("#dragM").on("dragstop", function() {
            setTimeout(() => { isDraggingM = false; }, 50);
        });

        $("#dragM").draggable({
            containment: "#map",
            start: function(event, ui) {
                isDraggingM = true; // 드래그 시작 시 플래그 설정
                const buttonDocPos = $(this).offset();
                const popupDocPos = $("#missionPopupContainer").offset();
                dragOffsetDiff = {
                    left: popupDocPos.left - buttonDocPos.left,
                    top: popupDocPos.top - buttonDocPos.top
                };
            },
            drag: function(event, ui) {
                let targetPopupDocLeft = ui.offset.left + dragOffsetDiff.left;
                let targetPopupDocTop = ui.offset.top + dragOffsetDiff.top;
                let popupViewportLeft = targetPopupDocLeft - $(window).scrollLeft();
                let popupViewportTop = targetPopupDocTop - $(window).scrollTop();
                $("#missionPopupContainer").css({
                    left: popupViewportLeft + 'px',
                    top: popupViewportTop + 'px'
                });
            },
            stop: function(event, ui) {
                let targetPopupDocLeft = ui.offset.left + dragOffsetDiff.left;
                let targetPopupDocTop = ui.offset.top + dragOffsetDiff.top;
                let popupViewportLeft = targetPopupDocLeft - $(window).scrollLeft();
                let popupViewportTop = targetPopupDocTop - $(window).scrollTop();
                $("#missionPopupContainer").css({
                    left: popupViewportLeft + 'px',
                    top: popupViewportTop + 'px'
                });
                // dragstop 후 isDraggingM을 false로 설정 (click 이벤트와의 충돌 방지)
                // setTimeout(() => { isDraggingM = false; }, 50); // 이미 dragstop 핸들러에 있음
            }
        });

        $("#missionPopupContainer").draggable({
            containment: "window",
            handle: "#missionPopupContainer",
            start: function(event, ui) {
                const popupDocPos = $(this).offset();
                const buttonDocPos = $("#dragM").offset();
                dragOffsetDiff = {
                    left: buttonDocPos.left - popupDocPos.left,
                    top: buttonDocPos.top - popupDocPos.top
                };
            },
            drag: function(event, ui) {
                 $("#dragM").offset({
                    left: ui.offset.left + dragOffsetDiff.left,
                    top: ui.offset.top + dragOffsetDiff.top
                });
            },
            stop: function(event, ui) { // 미션창 드래그 종료 시 버튼 위치 재동기화
                 $("#dragM").offset({
                    left: ui.offset.left + dragOffsetDiff.left,
                    top: ui.offset.top + dragOffsetDiff.top
                });
            }
        });

        $(document).on('click', '#dragM', function() {
            if (!isDraggingM) {
                openMissionPopup();
            }
        });

        // updateDestinationInfo 함수 정의 (HTML에 #destinationInfo 요소가 있다면 사용됨)
        function updateDestinationInfo() {
            // 로직은 이전과 동일하게 유지하나, #destinationInfo 요소가 HTML에 있는지 확인 필요
             if (touristSites && touristSites.length > 0 && statuses && statuses.length > 0) {
                let currentSiteValidIndex = statuses.findIndex(status => status === 2); // 진행중
                let displaySite;
                let progressText;

                if (currentSiteValidIndex !== -1 && touristSites[currentSiteValidIndex]) {
                    displaySite = touristSites[currentSiteValidIndex];
                    progressText = `${currentSiteValidIndex + 1}/${touristSites.filter(s=>s!=null).length}`;
                } else { // 진행중인 것 없음 (모두 대기 또는 모두 완료)
                    let firstWaitingIndex = statuses.findIndex(status => status === 0);
                    if (firstWaitingIndex !== -1 && touristSites[firstWaitingIndex]) { // 대기중인 첫번째
                        displaySite = touristSites[firstWaitingIndex];
                        progressText = `${firstWaitingIndex + 1}/${touristSites.filter(s=>s!=null).length}`;
                    } else if (touristSites.filter(s=>s!=null).length > 0) { // 모두 완료
                        displaySite = touristSites[touristSites.filter(s=>s!=null).length -1]; // 마지막 관광지
                        progressText = `${touristSites.filter(s=>s!=null).length}/${touristSites.filter(s=>s!=null).length}`;
                    }
                }

                if (displaySite) {
                    // console.log(`목적지: ${displaySite.name} (${progressText})`);
                    // $("#destinationInfo").text(`목적지: ${displaySite.name} (${progressText})`);
                } else {
                    // console.log("표시할 목적지 정보 없음");
                    // $("#destinationInfo").text("여행 정보 없음");
                }
            }
        }
        updateDestinationInfo(); // 초기 로드 시 호출
    });

    function copyUserCode() {
        const userCodeText = '{{ usercode }}';
        navigator.clipboard.writeText(userCodeText).then(() => {
            showToastMessage('User Code가 복사되었습니다!');
        }).catch(err => {
            console.error('복사 실패:', err);
            showToastMessage('복사에 실패했습니다.');
        });
    }

    function showToastMessage(message) {
        const toast = document.getElementById('toastMessage');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 2000);
    }
    function confirmReview() { window.location.href = '/review/' + usercode; }
    function acknowledgeComplete() { window.location.href = '/finished'; }
</script>
</body>
</html>