<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 여행 현황</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f8f9fa;
        /* position: relative; */ /* M 버튼과 팝업의 기준을 body로 삼기 위해 필요할 수 있음 */
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
        color: #343a40;
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #eee;
    }

    #map {
        width: 100%;
        height: 500px;
        background-color: #dcdcdc;
        border: 1px solid #ccc;
        margin-bottom: 20px;
        border-radius: 8px;
        position: relative;
        margin-bottom: 40px;
    }

    .map-footer {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 2;
    }

    .user-code {
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        font-size: 14px;
        z-index: 2;
    }

    .destination-info {
        text-align: center;
        font-size: 18px;
        font-weight: bold;
    }

    .site-list {
        list-style: none;
        padding: 0;
    }

    .site-item {
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
    }

    .grid-container {
        display: grid;
        grid-template-columns: 30% auto ;
        grid-gap: 10px;
        align-items: center;
    }

    .site-info {
        text-align: center;
        font-size: 28px;
    }
    .site-name-box {
        position: absolute;
        left: 43%;
        transform: translateX(-50%) translateY(-23px);
        white-space: nowrap;
        text-align: center;
        font-size: 24px;
        font-weight: 600;
        color: #3b3b3b;
        background-color: #ffffff;
        border-radius: 8px;
        border: 2px solid #ffffff;
        padding: 5px 13px;
    }

    .site-name-box:hover {
    color: rgb(77, 174, 119); /* 마우스를 올렸을 때 글자 색 */
    }

    .site-button {
        text-align: left;

    }

    .arrow-row {
        text-align: center;
    }

    .route-button {
        text-align: left;
    }

    .arrow {
        position: absolute;
        left: 43%;
        transform: translateX(-50%) translateY(-25px);
        font-size: 38px;
        transition: transform 0.3s ease-in-out;
        animation: none;
    }

    @keyframes upDown {
        0%, 100% {
            transform: translateX(-50%) translateY(-25px);
        }
        50% {
            transform: translateX(-50%) translateY(-20px);
        }
    }

    .arrow.blinking {
        animation: upDown 1s infinite;
    }

    .status-button {
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 83px;
        font-size: 18px;
        line-height: 42px;
        margin-bottom: 5px;
        margin-top: 5px;
        margin-left: 60%;
        text-align: center;
        padding: 0; /* 패딩 제거하여 높이 통일 */
    }

    .popup-button-group {
        display: flex;
        justify-content: center;
        gap: 24px; /* 버튼 간 간격 */
        margin-bottom: 20px;
    }

    .popup-button-group button {
        font-size: 16px;
        min-width: 70px;
        height: 36px;
        padding: 6px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        color: white;
        font-weight: bold;
        line-height: 1;
    }

    .status-button.waiting {
        background-color: #dc3545;
    }

    .status-button.in-progress {
        background-color: #007bff;
    }

    .status-button.completed {
        background-color: #28a745;
    }

    .status-button.waiting.blinking,
    .status-button.in-progress.blinking {
        animation: blinker 1s linear infinite;
    }

    @keyframes blinker {
        50% {
            opacity: 0.5;
        }
    }

    .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 5px 10px;
        border: 1px solid #ccc;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        width: 320px;
        align-items: center;     /* 세로 중앙 정렬 */
        justify-content: center; /* 가로 중앙 정렬 */
        font-size: 20px;
        text-align: center;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }

    .tmap-marker img {
        width: 65px;
        height: 30px;
    }

    .travel-time {
        padding: 8px 16px;
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 20px;
        font-size: 18px;
        color: #856404;
        text-align: left;
        width: fit-content;
        margin-top: auto;
    }

    .site-image {
        width: 150px;
        height: 100px;
        margin-right: 20px;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .site-placeholder {
        width: 150px;
        height: auto;
        aspect-ratio: 3 / 2;
        background-color: #dee2e6;
        margin-right: 20px;
        border-radius: 6px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #adb5bd;
        font-size: 16px;
    }

    .complete-button-container {
        text-align: center;
        margin-top: 20px;

    }

    .complete-button {
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        background-color: #28a745;
        transition: background-color 0.3s;
        font-size: 22px;
    }

    .complete-button:hover {
        background-color: #218838;
    }

    #dragM {
        position: absolute;
        top: 10px; /* 초기 위치 예시 */
        left: 10px; /* 초기 위치 예시 */
        width: 50px;
        height: 50px;
        background-image: url('/static/m_icon.png');
        background-size: cover;
        cursor: move;
        z-index: 1000; /* 팝업보다 아래, 지도보다는 위 */
    }

    #missionPopupContainer {
        position: absolute; /* fixed에서 absolute로 변경 */
        /* top, left 는 JS에서 동적으로 설정됩니다. */
        /* transform: translateY(-50%); 제거 */
        width: 400px;
        height: 75%;
        max-height: 750px;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1001; /* dragM 보다 위 */
        display: none;
        border-radius: 8px;
        overflow: hidden;
    }


    #missionPopup {
        width: 100%;
        height: 100%;
        border: none;
    }

    #closeButton {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1002;
        font-size: 14px;
        line-height: 1;
    }
    #closeButton:hover {
        background-color: #c0392b;
    }

    .toast-message {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s, bottom 0.3s;
        pointer-events: none;
    }

    @keyframes markerBlink {
        0%, 100% { opacity: 1.3; }
        50% { opacity: 0.5; }
    }

    .marker-blinking {
        animation: markerBlink 1s infinite;
    }

    .toast-message.show {
        opacity: 1;
        bottom: 30px;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* 반투명 배경 */
        z-index: 1000;
        display: none; /* 기본적으로 숨김 */
        justify-content: flex-end; /* 팝업을 오른쪽에 정렬 */
        align-items: stretch; /* 팝업 높이를 화면 전체로 */
        overflow: hidden; /* 부모 요소에서 스크롤 제거 */
    }

    .modal-content {
        position: relative;
        width: 30%; /* 팝업 너비 */
        height: 100%; /* 팝업 높이 */
        background-color: white;
        box-shadow: -2px 0 12px rgba(0, 0, 0, 0.2);
        overflow: hidden; /* 내부 콘텐츠 스크롤 제거 */
        transform: translateX(100%); /* 기본적으로 화면 오른쪽 밖에 숨김 */
        transition: transform 0.3s ease-in-out; /* 애니메이션 효과 */
    }

    .modal-content.open {
        transform: translateX(0); /* 화면 안으로 슬라이드 */
    }

    .modal-header {
        position: relative;
        height: 50px; /* 헤더 높이 */
        background-color: #f1f1f1; /* 헤더 배경색 */
        border-bottom: 1px solid #ddd; /* 헤더 아래 테두리 */
        display: flex;
        align-items: center;
        justify-content: flex-end; /* 닫기 버튼을 오른쪽에 배치 */
        padding: 0 15px; /* 헤더 내부 여백 */
    }

    .modal-header .close {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        cursor: pointer;
    }

    .modal-header .close:hover {
        color: #e74c3c;
    }

    .modal-body {
        height: calc(100% - 50px); /* 헤더를 제외한 나머지 공간 */
        overflow: hidden; /* 스크롤 제거 */
    }

</style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=Mb9cttQ9De2UcPzNfNwCl7ZRY31kNiUqPjCAeZne&callback=tmapApiLoaded"></script>
</head>

<body>
    <div class="container">
        <h1>실시간 여행 현황</h1>
        <div id="map">
            <div id="dragM"></div>
            <div class="map-footer">
                <div class="user-code" onclick="copyUserCode()">User Code: {{ usercode }}</div>
            </div>
        </div>

        <ul class="site-list">
    {% for i in range(count) %}
    <li class="site-item">
        <div class="grid-container">
            <div class="site-info">
                <div class="site-name-box" onclick="openPanel('{{ tourist_sites[i].name }}', '{{ tourist_sites[i-1].name if i > 0 else 'NULL' }}')">
                    {{ tourist_sites[i].name }}
                </div>
            </div>
            <div class="site-button">
                {% if statuses[i] == 0 %}
                    {% if i == 0 or (statuses[i-1] == 1 and (i == 1 or routes[i-2].status == 1)) %}
                        <button class="status-button waiting" onclick="openPopup('site', '{{ usercode }}', {{ i + 1 }}, 2)">대기</button>
                    {% else %}
                        <button class="status-button waiting" disabled>대기</button>
                    {% endif %}
                {% elif statuses[i] == 2 %}
                    <button class="status-button in-progress blinking" onclick="openCompletePopup('{{ usercode }}', {{ i + 1 }})">진행중</button>
                {% elif statuses[i] == 1 %}
                    <button class="status-button completed" onclick="openCancelPopup('site', '{{ usercode }}', {{ i + 1 }})">완료</button>
                {% endif %}
            </div>

            {% if i < count - 1 %}
            <div class="arrow-row">
                <div class="arrow {% if routes[i].status == 2 %}blinking{% endif %}">↓</div>
            </div>
            <div class="route-button">
                {% if routes[i].status == 0 %}
                    {% if statuses[i] == 1 %}
                        <button class="status-button waiting" onclick="openPopup('route', '{{ usercode }}', {{ i + 1 }}, 2)">대기</button>
                    {% else %}
                        <button class="status-button waiting" disabled>대기</button>
                    {% endif %}
                {% elif routes[i].status == 2 %}
                    <button class="status-button in-progress blinking" onclick="openPopup('route', '{{ usercode }}', {{ i + 1 }}, 1)">진행중</button>
                {% elif routes[i].status == 1 %}
                    <button class="status-button completed" onclick="openCancelPopup('route', '{{ usercode }}', {{ i + 1 }})">완료</button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </li>
    {% endfor %}
</ul>

        {% if statuses[-1] == 1 %}
        <div class="complete-button-container">
            <button class="complete-button" onclick="completeAll()">여행 완료</button>
        </div>
        {% endif %}

        <div class="popup" id="statusPopup">
            <h2>경로 완료 확인</h2>
            <p id="popupMessage"></p>
            <div class="popup-button-group">
                <button onclick="updateStatus()" style="background-color: #28a745;">예</button>
                <button onclick="closePopup()" style ="background-color: #dc3545;">아니오</button>
            </div>
        </div>

        <div class="popup" id="cancelPopup" >
            <h2>취소 확인</h2>
            <p>취소하시겠습니까?</p>
            <div class="popup-button-group">
                <button onclick="cancelStatus()" style="background-color: #28a745;">예</button>
                <button onclick="closePopup()" style ="background-color: #dc3545;">아니오</button>
            </div>
        </div>

        <div class="popup" id="completePopup" >
            <h2>여행 완료 확인</h2>
            <p>여행을 완료하셨습니까?</p>
            <div class="popup-button-group">
            <button onclick="completeStatus()" style="background-color: #28a745;">예</button>
            <button onclick="closePopup()" style ="background-color: #dc3545; ">아니오</button>
            </div>
        </div>

        <div class="popup" id="confirmCompletePopup" style="min-width: 400px;">
            <h2>모든 여행이 완료되었습니다!</h2>
            <p>후기를 작성하시겠습니까?</p>
            <div class="popup-button-group">
                <button onclick="confirmReview()" style="background-color: #28a745;">예</button>
                <button onclick="acknowledgeComplete()" style="background-color: #dc3545;">아니오</button>
                <button onclick="closePopup()" style="background-color: #6c757d; margin-left: 40px;">닫기</button>
            </div>
        </div>

        <div class="overlay" id="popupOverlay"></div>

        </div>
    <div id="missionPopupContainer">
        <button id="closeButton" onclick="closeMissionPopup()">닫기</button>
        <iframe id="missionPopup" src="about:blank" ></iframe>
    </div>
    <div id="toastMessage" class="toast-message"></div>

    <script>
        let map;
        let markers = [];
        let polylines = [];
        let usercode = '{{ usercode }}';
        let currentType = '';
        let currentNumber = 0;
        let newStatus = 0;
        let touristSites = {{ tourist_sites | tojson }};
        let statuses = {{ statuses | tojson }};
        let routes = {{ routes | tojson }};
        let tmapLoaded = false;
        let infoWindow;
        const apiKey = "Mb9cttQ9De2UcPzNfNwCl7ZRY31kNiUqPjCAeZne";
        const startIcon = "/static/start.png";
        const middleIcon = "/static/middle.png";
        const endIcon = "/static/end.png";
        let city = "서울";

        // 미션 팝업 관련 변수
        let missionPopupContainerEl;
        let dragMEl;
        const missionPopupWidth = 400; // CSS에 정의된 #missionPopupContainer의 너비
        const popupMargin = 15;      // M 버튼과 팝업 사이의 여백

        function openPopup(type, usercode, number, status) {

            console.log("openPopup 호출", type, usercode, number, status);
            currentType = type;
            currentUsercode = usercode;
            currentNumber = number;
            newStatus = status;

            let popupMessage = "";
            if (type === 'site') {
                if (statuses[number - 1] === 0) {
                    popupMessage = "여행을 시작하시겠습니까?";
                } else if (statuses[number - 1] === 2) {
                    popupMessage = "여행을 완료하셨습니까?";
                } else if (statuses[number - 1] === 1) {
                    popupMessage = "여행을 취소하시겠습니까?";
                }
            } else if (type === 'route') {
                if (routes[number - 1].status === 0) {
                    popupMessage = "경로를 시작하시겠습니까?";
                } else if (routes[number - 1].status === 2) {
                    popupMessage = "경로를 완료하셨습니까?";
                } else if (routes[number - 1].status === 1) {
                    popupMessage = "경로를 취소하시겠습니까?";
                }
            }
            document.getElementById('popupMessage').innerText = popupMessage;

            document.getElementById('statusPopup').style.display = 'block';
            document.getElementById('cancelPopup').style.display = 'none';
            document.getElementById('completePopup').style.display = 'none';
            document.getElementById('popupOverlay').style.display = 'block';
        }

        function openCompletePopup(usercode, number) {

            console.log("openCompletePopup 호출", usercode, number);
            currentUsercode = usercode;
            currentNumber = number;

            document.getElementById('statusPopup').style.display = 'none';
            document.getElementById('cancelPopup').style.display = 'none';
            document.getElementById('completePopup').style.display = 'block';
            document.getElementById('popupOverlay').style.display = 'block';
        }

        function openCancelPopup(type, usercode, number) {

             console.log("openCancelPopup 호출", type, usercode, number);
            currentType = type;
            currentUsercode = usercode;
            currentNumber = number;

            document.getElementById('statusPopup').style.display = 'none';
            document.getElementById('cancelPopup').style.display = 'block';
            document.getElementById('completePopup').style.display = 'none';
            document.getElementById('popupOverlay').style.display = 'block';
        }

        function closePopup() {
            document.getElementById('statusPopup').style.display = 'none';
            document.getElementById('cancelPopup').style.display = 'none';
            document.getElementById('completePopup').style.display = 'none';
            document.getElementById('confirmCompletePopup').style.display = 'none';
            document.getElementById('popupOverlay').style.display = 'none';
        }

        async function updateStatus() {

            let url = '/update_status';
            let data = {
                usercode: usercode,
                site_number: currentNumber,
                new_status: newStatus
            };

            if (currentType === 'route') {
                url = '/update_route_status';
                data.route_number = currentNumber;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();

                if (result.status === 'success') {
                    if (currentType === 'site') {
                        if (currentNumber < touristSites.length) {
                            await updateRouteStatus(currentNumber, 2);
                        }
                    } else if (currentType === 'route') {
                        if (currentNumber + 1 <= touristSites.length) {
                            await updateSiteStatus(currentNumber + 1, 2);
                        }
                    }
                    location.reload();
                } else {
                    alert('상태 업데이트 실패: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('상태 업데이트 중 오류 발생');
            }
            closePopup();
        }

        async function completeStatus() {

            try {
                const response = await fetch('/update_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usercode: usercode,
                        site_number: currentNumber,
                        new_status: 1
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                if (data.status === 'success') {
                    if (currentNumber < touristSites.length) {
                        await updateRouteStatus(currentNumber, 2);
                    }
                    location.reload();
                } else {
                    alert('상태 업데이트 실패: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('상태 업데이트 중 오류 발생');
            }
            closePopup();
        }

        async function cancelStatus() {

            const data = {
                usercode: usercode,
                item_type: currentType,
                item_number: currentNumber
            };

            try {
                const response = await fetch('/update_cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const result = await response.json();
                if (result.status === 'success') {
                    location.reload();
                } else {
                    alert('상태 취소 실패: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('상태 취소 중 오류 발생');
            }
            closePopup();
        }

        async function updateSiteStatus(siteNumber, status) {
            try {
                const response = await fetch('/update_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usercode: usercode,
                        site_number: siteNumber,
                        new_status: status
                    })
                });
                if (!response.ok) { throw new Error('Network response was not ok'); }
                const data = await response.json();
                if (data.status === 'success') {
                    console.log(`관광지 ${siteNumber} 상태가 ${status}로 업데이트되었습니다.`);
                    location.reload();
                } else {
                    alert(`관광지 ${siteNumber} 상태 업데이트 실패: ` + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('관광지 상태 업데이트 중 오류 발생');
            }
        }

        async function updateRouteStatus(routeNumber, status) {

             try {
                const response = await fetch('/update_route_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usercode: usercode,
                        route_number: routeNumber,
                        new_status: status
                    })
                });
                if (!response.ok) { throw new Error('Network response was not ok');}
                const data = await response.json();
                if (data.status === 'success') {
                    console.log(`경로 ${routeNumber} 상태가 ${status}로 업데이트되었습니다.`);
                    location.reload();
                } else {
                    alert(`경로 ${routeNumber} 상태 업데이트 실패: ` + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('경로 상태 업데이트 중 오류 발생');
            }
        }

        function initializeMap() {

            const cityCoordinates = {
                "서울": { lat: 37.5665, lng: 126.9780 },
                "청주": { lat: 36.6424341, lng: 127.4890319 },
                "부산": { lat: 35.1796, lng: 129.0756 },
                "제주": { lat: 33.4996, lng: 126.5312 }
            };
            const center = cityCoordinates[city] || cityCoordinates["서울"];
            map = new Tmapv2.Map("map", {
                center: new Tmapv2.LatLng(center.lat, center.lng),
                width: "100%",
                height: "500px",
                zoom: 12
            });
            infoWindow = new Tmapv2.InfoWindow({
                position: new Tmapv2.LatLng(0, 0),
                border: '0px solid #FFFFFF',
                background: '#333333',
                color: '#ffffff',
                text: '',
                visible: false,
                padding: '5px',
                align: 'center'
            });
            infoWindow.setMap(map);
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        function updateMapMarkers() {

             if (!tmapLoaded) {
                console.warn("Tmap API가 아직 로드되지 않았습니다. 마커 업데이트를 연기합니다.");
                return;
            }
            clearMarkers();
            touristSites.forEach((site, index) => {
                if (site && site.mapy && site.mapx) {
                   let markerIcon;
                    if (index === 0) markerIcon = startIcon;
                    else if (index === touristSites.length - 1) markerIcon = endIcon;
                    else markerIcon = middleIcon;

                    const lonLat = new Tmapv2.LatLng(site.mapy, site.mapx);
                    const marker = new Tmapv2.Marker({
                        position: lonLat,
                        icon: markerIcon,
                        iconSize: new Tmapv2.Size(65, 30),
                        title: site.name,
                        map: map
                    });
                    if (statuses[index] === 2) {
                        const el = marker.getElement();
                        if (el) el.classList.add('marker-blinking');
                    }
                    markers.push(marker);
                } else {
                    console.error(`유효하지 않은 위치 정보: ${site.name}`);
                }
            });
            if (markers.length > 0) {
                const bounds = new Tmapv2.LatLngBounds();
                for (var i = 0; i < markers.length; i++) {
                    bounds.extend(markers[i].getPosition());
                }
                if (touristSites.length === 1) {
                    map.setCenter(markers[0].getPosition());
                    map.setZoom(15);
                } else {
                    map.fitBounds(bounds);
                }
            }
        }

        function getTmapPath() {

            if (!tmapLoaded) { console.warn("Tmap API 로드 전, 경로 요청 연기."); return; }
            clearPolylines();
            if (touristSites.length < 2) { console.warn("경로를 그리려면 2개 이상 위치 필요."); return; }
            let promises = [];
            for (let i = 0; i < touristSites.length - 1; i++) {
                const startPoint = touristSites[i];
                const endPoint = touristSites[i + 1];
                if (!startPoint || !endPoint || !startPoint.mapx || !startPoint.mapy || !endPoint.mapx || !endPoint.mapy) {
                    console.error("시작/종료점 좌표 유효하지 않음."); continue;
                }
                const requestData = {
                    startX: startPoint.mapx, startY: startPoint.mapy,
                    endX: endPoint.mapx, endY: endPoint.mapy,
                    reqCoordType: "WGS84GEO", resCoordType: "WGS84GEO",
                    startName: touristSites[i].name, endName: touristSites[i + 1].name
                };
                const promise = $.ajax({
                    method: "POST",
                    url: "https://apis.openapi.sk.com/tmap/routes/pedestrian?version=1&format=json",
                    headers: { "Accept": "application/json", "Content-Type": "application/json; charset=utf-8", "appKey": apiKey },
                    data: JSON.stringify(requestData)
                });
                promises.push(promise);
            }
            Promise.all(promises)
                .then(results => {
                    results.forEach((response, index) => {
                        const resultData = response.features;
                        let color = "#DD0000";
                        if (routes[index].status === 2) color = "#007bff";
                        else if (routes[index].status === 1) color = "#28a745";
                        drawTmapPath(resultData, color);
                    });
                })
                .catch(error => { console.error("경로 요청 실패:", error, error.responseText); });
        }

        function drawTmapPath(pathData, color = "#DD0000") {

            if (!pathData) { console.warn("경로 데이터 없음."); return; }
            for (let i in pathData) {
                const geometry = pathData[i].geometry;
                if (geometry.type === "LineString") {
                    const coords = geometry.coordinates;
                    const line = new Tmapv2.Polyline({
                        path: coords.map(coord => new Tmapv2.LatLng(coord[1], coord[0])),
                        strokeColor: color, strokeWeight: 6, map: map
                    });
                    polylines.push(line);
                }
            }
        }

        function clearPolylines() {
            for (let i in polylines) { polylines[i].setMap(null); }
            polylines = [];
        }

        async function completeAll() {
            document.getElementById('confirmCompletePopup').style.display = 'block';
            document.getElementById('popupOverlay').style.display = 'block';
        }

        function tmapApiLoaded() {
            console.log("Tmapv2 API 로드 완료");
            init();
        }
        window.tmapApiLoaded = tmapApiLoaded;

        function init() {
            if (typeof Tmapv2 !== 'undefined') {
                initializeMap();
                tmapLoaded = true;
                updateMapMarkers();
                getTmapPath();
            } else {
                console.error("Tmapv2 API 스크립트 로드 실패");
                setTimeout(init, 500);
            }
        }

        function onError(error) {
            alert("경로 요청 중 오류가 발생했습니다: " + error);
            console.error("경로 요청 오류:", error);
        }


        function openMissionPopup() {
            const usercode = '{{ usercode }}';
            if (!usercode) {
                console.error("usercode가 없습니다.");
                return;
            }

            if (!dragMEl || !dragMEl.length || !missionPopupContainerEl || !missionPopupContainerEl.length) {
                console.error("#dragM 또는 #missionPopupContainer 요소를 찾을 수 없습니다.");
                // 요소가 없으면 기본 동작 또는 오류 메시지
                $("#missionPopup").attr("src", `/mission?usercode=${usercode}`);
                $("#missionPopupContainer").css({ display: 'block', top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }); // 예: 중앙 정렬
                return;
            }

            // dragMEl의 현재 위치 (offsetParent 기준)
            const dragMPos = dragMEl.position(); // {top, left}
            const dragMOffset = dragMEl.offset(); // 문서 기준 {top, left}

            // missionPopupContainerEl의 offsetParent의 offset을 가져옵니다.
            // dragM과 missionPopupContainer가 같은 부모를 가지거나,
            // missionPopupContainer가 body의 직계 자식일 경우 계산이 간단해집니다.
            // 현재 HTML 구조상 missionPopupContainerEl는 .container의 형제 요소로, body의 자식입니다.
            // dragMEl은 #map의 자식입니다. #map은 .container의 자식입니다.
            // 따라서, dragMEl의 절대 위치(offset)를 사용하고, missionPopupContainerEl의 위치를 그에 맞게 설정합니다.

            let popupTop = dragMOffset.top; // M 버튼의 상단에 팝업의 상단을 맞춤
            let popupLeft = dragMOffset.left - missionPopupWidth - popupMargin; // M 버튼의 왼쪽에 위치

            // 화면 왼쪽 가장자리를 벗어나지 않도록 함
            popupLeft = Math.max(0, popupLeft);
            // 화면 상단 가장자리를 벗어나지 않도록 함
            popupTop = Math.max(0, popupTop);

            missionPopupContainerEl.css({
                top: popupTop + 'px',
                left: popupLeft + 'px',
                display: 'block'
            });

            $("#missionPopup").attr("src", `/mission?usercode=${usercode}`);
        }

        function closeMissionPopup() {
            if (missionPopupContainerEl) {
                missionPopupContainerEl.css("display", "none");
            }
            $("#missionPopup").attr("src", "about:blank");
        }

        $(document).ready(function () {
            // DOM 요소 캐싱
            missionPopupContainerEl = $("#missionPopupContainer");
            dragMEl = $("#dragM");

            init();

            let firstSiteProcessed = localStorage.getItem('firstSiteProcessed');
            if (!firstSiteProcessed) {
                updateSiteStatus(1, 2);
                localStorage.setItem('firstSiteProcessed', 'true');
            }

            if (dragMEl.length) {
                dragMEl.draggable({
                    containment: "document", // body 또는 특정 컨테이너로 제한 가능
                    drag: function(event, ui) {
                        // M 버튼이 드래그되는 동안 미션 팝업 위치 동기화
                        if (missionPopupContainerEl.is(":visible")) {
                            // ui.position은 draggable helper의 현재 position (offsetParent 기준)
                            // ui.offset은 draggable helper의 현재 offset (document 기준)
                            let newTop = ui.offset.top;
                            let newLeft = ui.offset.left - missionPopupWidth - popupMargin;

                            // 화면 왼쪽 가장자리를 벗어나지 않도록 newLeft 조정
                            newLeft = Math.max(0, newLeft);
                            // 화면 상단 가장자리를 벗어나지 않도록 newTop 조정
                            newTop = Math.max(0, newTop);

                            missionPopupContainerEl.css({
                                top: newTop + 'px',
                                left: newLeft + 'px'
                            });
                        }
                    },
                    stop: function(event, ui) {
                        console.log("M 버튼 최종 위치 (offset): top=" + ui.offset.top + ", left=" + ui.offset.left);
                        // 드래그 멈췄을 때 최종 위치 한번 더 동기화 (선택사항, drag에서 이미 잘 처리됨)
                         if (missionPopupContainerEl.is(":visible")) {
                            let finalTop = ui.offset.top;
                            let finalLeft = ui.offset.left - missionPopupWidth - popupMargin;
                            finalLeft = Math.max(0, finalLeft);
                            finalTop = Math.max(0, finalTop);
                            missionPopupContainerEl.css({
                                top: finalTop + 'px',
                                left: finalLeft + 'px'
                            });
                        }
                    }
                });
            } else {
                console.error("#dragM 요소를 찾을 수 없습니다.");
            }

            $(document).on('click', '#dragM', function() {
                if (missionPopupContainerEl.is(":visible")) {
                    closeMissionPopup();
                } else {
                    openMissionPopup();
                }
            });

            function updateDestinationInfo() {
                let currentSiteIndex = statuses.findIndex(status => status === 2);
                if (currentSiteIndex === -1) currentSiteIndex = touristSites.length - 1;
                let nextSite = touristSites[currentSiteIndex];
                let progress = Math.min(currentSiteIndex + 1, touristSites.length);
                // let infoText = `목적지: ${nextSite.name} (${progress}/${touristSites.length})`;
                // $("#destinationInfo").text(infoText); // 해당 ID가 HTML에 없음
            }
            updateDestinationInfo();

            const originalUpdateStatusInternal = updateStatus; // 이름 충돌 방지
            updateStatus = async function () { // 전역 updateStatus를 덮어쓰므로 주의
                await originalUpdateStatusInternal.apply(this, arguments);
                updateDestinationInfo();
            };
        });

        function copyUserCode() {
            const userCodeToCopy = '{{ usercode }}'; // usercode 변수명 일치
            navigator.clipboard.writeText(userCodeToCopy).then(() => {
                showToastMessage('User Code가 복사되었습니다!');
            }).catch(err => {
                console.error('복사 실패:', err);
                showToastMessage('복사에 실패했습니다.');
            });
        }

        function showToastMessage(message) {
            const toast = document.getElementById('toastMessage');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
        function confirmReview() {
            window.location.href = '/review/' + usercode;
        }
        function acknowledgeComplete() {
            window.location.href = '/finished';
        }
    </script>
    <script>
        function openPanel(currentSiteName, previousSiteName) {
            if (!currentSiteName) {
                console.error("현재 관광지 이름이 없습니다.");
                return;
            }

            const panelUrl = `/imformation_live/${encodeURIComponent(currentSiteName)}/${encodeURIComponent(previousSiteName)}`;
            const modalIframe = document.getElementById('modalIframe');
            const infoModal = document.getElementById('infoModal');
            const modalContent = document.getElementById('modalContent');

            console.log("팝업 열기: ", panelUrl); // 디버깅용 로그
            modalIframe.src = panelUrl; // iframe에 URL 설정
            infoModal.style.display = 'flex'; // 팝업 활성화
            setTimeout(() => {
                modalContent.classList.add('open'); // 애니메이션 시작
            }, 10); // 약간의 지연을 줘야 애니메이션이 적용됨
        }

        function closePanel() {
            const infoModal = document.getElementById('infoModal');
            const modalContent = document.getElementById('modalContent');
            const modalIframe = document.getElementById('modalIframe');

            console.log("팝업 닫기"); // 디버깅용 로그
            modalContent.classList.remove('open'); // 애니메이션 종료
            setTimeout(() => {
                infoModal.style.display = 'none'; // 팝업 비활성화
                modalIframe.src = ''; // iframe 초기화
            }, 300); // 애니메이션 지속 시간과 동일하게 설정
        }
    </script>
<div id="infoModal" class="modal-overlay" onclick="closePanel()">
    <div id="modalContent" class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <span class="close" onclick="closePanel()">×</span>
        </div>
        <div class="modal-body">
            <iframe id="modalIframe" src="about:blank" frameborder="0" style="width: 100%; height: 100%;"></iframe>
        </div>
    </div>
</div>
</body>
</html>