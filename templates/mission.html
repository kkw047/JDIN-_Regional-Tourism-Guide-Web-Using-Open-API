<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미션 상세</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0; /* iframe 내부 body의 불필요한 마진/패딩 제거 */
            display: flex;
            flex-direction: column;
            height: 100vh; /* 뷰포트 전체 높이를 사용 */
            box-sizing: border-box; /* 패딩이 높이에 포함되도록 */
        }

        .mission-container {
            padding: 15px; /* 내부 컨테이너에 패딩 적용 */
            flex-grow: 1; /* 남은 공간을 모두 차지 */
            overflow-y: auto; /* 이 컨테이너에서만 스크롤이 발생하도록 설정 (핵심!) */
            -webkit-overflow-scrolling: touch; /* iOS Safari 부드러운 스크롤 */
            border-bottom: 1px solid #eee; /* 선택 사항: 미션 목록과 버튼 사이에 구분선 */
        }

        .mission-item {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
        }

        .mission-item h4 {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .mission-item p {
            font-size: 0.95em;
            color: #666;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .mission-status-toggle {
            display: block;
            width: 100%;
            padding: 8px 15px;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            text-align: center;
        }

        .mission-status-toggle.confirmed {
            background-color: #28a745;
            border-color: #28a745;
        }

        .mission-status-toggle:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .mission-status-toggle.confirmed:hover {
            background-color: #218838;
            border-color: #218838;
        }

        .no-missions {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #555;
        }

        .mission-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            background-color: #f0f0f0;
            text-align: center;
            flex-shrink: 0; /* 푸터가 줄어들지 않도록 고정 */
        }
    </style>
</head>
<body>
    <div class="mission-container">
        <div class="loading" id="loadingMessage">미션 정보를 불러오는 중...</div>
        <div id="missionList">
            </div>
        <div class="no-missions" id="noMissionsMessage" style="display: none;">미션이 없습니다.</div>
    </div>
    <div class="mission-footer">
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const usercode = urlParams.get('usercode');
            const missionListDiv = document.getElementById('missionList');
            const loadingMessage = document.getElementById('loadingMessage');
            const noMissionsMessage = document.getElementById('noMissionsMessage');

            if (usercode) {
                fetch(`/get_mission_details/${usercode}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingMessage.style.display = 'none'; // 로딩 메시지 숨기기
                        if (data.success && data.missions.length > 0) {
                            data.missions.forEach(mission => {
                                const missionItem = document.createElement('div');
                                missionItem.className = 'mission-item';
                                missionItem.innerHTML = `
                                    <h4>${mission.title}</h4>
                                    <p>${mission.content}</p>
                                    <button class="mission-status-toggle ${mission.confirmed ? 'confirmed' : ''}"
                                            data-mission-seq="${mission.mission_seq}"
                                            data-usercode="${usercode}"
                                            data-confirmed="${mission.confirmed ? 'true' : 'false'}">
                                        ${mission.confirmed ? '미션 완료됨' : '미션 완료하기'}
                                    </button>
                                `;
                                missionListDiv.appendChild(missionItem);
                            });

                            // 이벤트 리스너를 미션 아이템에 추가
                            document.querySelectorAll('.mission-status-toggle').forEach(button => {
                                button.addEventListener('click', function() {
                                    const currentUsercode = this.dataset.usercode;
                                    const missionSeq = parseInt(this.dataset.missionSeq);
                                    let isConfirmed = this.dataset.confirmed === 'true'; // 현재 상태

                                    // 상태 토글
                                    isConfirmed = !isConfirmed;

                                    fetch('/update_mission_status', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            usercode: currentUsercode,
                                            mission_seq: missionSeq,
                                            confirmed: isConfirmed
                                        }),
                                    })
                                    .then(response => response.json())
                                    .then(updateData => {
                                        if (updateData.success) {
                                            // UI 업데이트
                                            this.dataset.confirmed = isConfirmed ? 'true' : 'false';
                                            if (isConfirmed) {
                                                this.classList.add('confirmed');
                                                this.textContent = '미션 완료됨';
                                            } else {
                                                this.classList.remove('confirmed');
                                                this.textContent = '미션 완료하기';
                                            }
                                            alert(updateData.message);
                                        } else {
                                            alert('미션 상태 업데이트 실패: ' + updateData.error);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error updating mission status:', error);
                                        alert('미션 상태 업데이트 중 오류가 발생했습니다.');
                                    });
                                });
                            });

                        } else {
                            noMissionsMessage.style.display = 'block'; // 미션 없음 메시지 표시
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching mission details:', error);
                        loadingMessage.style.display = 'none';
                        noMissionsMessage.textContent = '미션 정보를 불러오는 데 실패했습니다.';
                        noMissionsMessage.style.display = 'block';
                    });
            } else {
                loadingMessage.style.display = 'none';
                noMissionsMessage.textContent = 'Usercode가 제공되지 않았습니다.';
                noMissionsMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>