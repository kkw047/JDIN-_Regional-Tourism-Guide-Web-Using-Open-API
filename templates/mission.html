<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 미션</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            /* live.html의 #missionPopupContainer에서 padding을 주거나, 여기서 body에 padding을 줍니다. */
            /* 여기서는 body에 padding을 주어 닫기 버튼과 콘텐츠가 겹치지 않도록 합니다. */
            padding: 45px 10px 10px 10px; /* 상단에 닫기 버튼 영역 확보, 좌우하단 여백 */
            box-sizing: border-box;
            background-color: #f8f9fa; /* 배경색은 그대로 유지 */
            height: 100vh; /* iframe이 꽉 차도록 */
            display: flex;
            flex-direction: column;
        }

        .mission-container {
            flex-grow: 1;
            overflow-y: auto; /* 내용이 많을 경우 스크롤 */
            padding: 15px; /* 내부 콘텐츠 영역 패딩 */
            background-color: white;
            border-radius: 0 0 8px 8px; /* live.html의 팝업과 어울리도록 하단 모서리만 */
        }

        .mission-item {
            /* display: flex 와 flex-direction: column; 대신 block 요소로 자연스럽게 세로 배치 */
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .mission-site-info {
            text-align: center; /* 내부 요소들 중앙 정렬 */
            margin-bottom: 15px; /* 관광지 정보와 미션 제목 사이 간격 */
            width: 100%; /* 부모 요소 너비에 맞춤 */
        }

        .mission-site-image {
            width: 100%; /* 이미지 너비를 컨테이너에 맞춤 */
            max-width: 250px; /* 이미지 최대 너비 제한 (너무 커지지 않도록) */
            height: auto; /* 너비에 맞춰 높이 자동 조절 */
            aspect-ratio: 16 / 9; /* 이미지 비율 유지 (선택 사항) */
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px; /* 이미지와 관광지 이름 사이 간격 */
            background-color: #e9ecef;
        }
        .site-image-placeholder {
            width: 100%;
            max-width: 250px;
            height: 150px; /* 플레이스홀더 높이 고정 또는 aspect-ratio 사용 */
            /* aspect-ratio: 16 / 9; */
            background-color: #e9ecef;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
            font-size: 14px;
            margin: 0 auto 10px auto; /* 중앙 정렬 및 하단 여백 */
        }

        .mission-site-name { /* 관광지 제목(이름) */
            font-size: 1.2em; /* 크기 키움 */
            color: #333;
            font-weight: bold;
            margin-bottom: 15px; /* 관광지 이름과 미션 제목 사이 간격 */
        }

        .mission-details h4 { /* 미션 제목 */
            font-size: 1.1em; /* 크기 조정 */
            color: #4A90E2; /* 색상 변경으로 구분 */
            margin-top: 0; /* 위쪽 여백 제거 (이미 .mission-site-name에서 충분히 띄움) */
            margin-bottom: 8px;
            font-weight: bold;
        }

        .mission-details p { /* 미션 설명 */
            font-size: 0.95em;
            color: #555; /* 약간 더 진하게 */
            line-height: 1.6; /* 줄 간격 늘림 */
            margin-bottom: 15px;
        }

        /* 버튼 스타일은 기존 유지 */
        .mission-status-toggle {
            display: block;
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            text-align: center;
            font-weight: bold;
        }
        .mission-status-toggle.pending { background-color: #007bff; color: white; }
        .mission-status-toggle.pending:hover { background-color: #0056b3; }
        .mission-status-toggle.confirmed { background-color: #28a745; color: white; }
        .mission-status-toggle.confirmed:hover { background-color: #218838; }
        .mission-status-toggle:disabled { background-color: #cccccc; cursor: not-allowed; }


        .no-missions, .loading {
            text-align: center;
            color: #888;
            padding: 30px;
            font-size: 1.1em;
        }

        .mission-footer {
            padding: 10px; /* 푸터 패딩 약간 줄임 */
            border-top: 1px solid #eee;
            background-color: #f0f0f0;
            text-align: center;
            flex-shrink: 0;
            font-size: 0.8em; /* 푸터 글씨 크기 약간 줄임 */
            color: #555;
            border-radius: 0 0 6px 6px; /* 컨테이너 하단 모서리와 맞춤 */
        }

    </style>
</head>
<body>
    <div class="mission-container">
        <div class="loading" id="loadingMessage">미션 정보를 불러오는 중...</div>
        <div id="missionList">
            </div>
        <div class="no-missions" id="noMissionsMessage" style="display: none;">현재 진행 중인 미션이 없습니다.</div>
    </div>
    <div class="mission-footer">
        미션은 관광지당 1개씩 제공됩니다.
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const usercode = urlParams.get('usercode');
            const missionListDiv = document.getElementById('missionList');
            const loadingMessage = document.getElementById('loadingMessage');
            const noMissionsMessage = document.getElementById('noMissionsMessage');

            if (usercode) {
                fetch(`/get_mission_details/${usercode}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('네트워크 응답이 올바르지 않습니다 ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        loadingMessage.style.display = 'none';

                        if (data.success && data.missions && data.missions.length > 0) {
                            let hasValidMissions = false;
                            data.missions.forEach((mission) => {
                                if (mission && mission.id) {
                                    hasValidMissions = true;
                                    const missionItem = document.createElement('div');
                                    missionItem.className = 'mission-item';

                                    // 1. 관광지 정보 (이미지, 이름)
                                    const siteInfoDiv = document.createElement('div');
                                    siteInfoDiv.className = 'mission-site-info';

                                    let siteImageHTML = '';
                                    if (mission.site_image) {
                                        siteImageHTML = `<img src="${mission.site_image}" alt="${mission.site_name || '관광지 이미지'}" class="mission-site-image">`;
                                    } else {
                                        siteImageHTML = `<div class="site-image-placeholder">이미지 없음</div>`;
                                    }
                                    // 관광지 이름(mission-site-name)은 siteInfoDiv에 이미지 다음에 추가
                                    siteInfoDiv.innerHTML = siteImageHTML + `<div class="mission-site-name">${mission.site_name || '관광지 정보 없음'}</div>`;

                                    missionItem.appendChild(siteInfoDiv); // 관광지 정보 먼저 추가

                                    // 2. 미션 상세 (제목, 내용, 버튼)
                                    const missionDetailsDiv = document.createElement('div');
                                    missionDetailsDiv.className = 'mission-details'; // 이 클래스는 스타일링 그룹핑 용도

                                    // 미션 제목(h4), 미션 내용(p), 버튼 순으로 추가
                                    missionDetailsDiv.innerHTML = `
                                        <h4>${mission.title}</h4>
                                        <p>${mission.content}</p>
                                        <button class="mission-status-toggle ${mission.confirmed ? 'confirmed' : 'pending'}"
                                                data-mission-number="${mission.mission_number}"
                                                data-usercode="${usercode}"
                                                data-confirmed="${mission.confirmed ? 'true' : 'false'}">
                                            ${mission.confirmed ? '미션 완료됨' : '미션 완료하기'}
                                        </button>
                                    `;
                                    missionItem.appendChild(missionDetailsDiv); // 미션 상세 정보 추가

                                    missionListDiv.appendChild(missionItem);
                                }
                            });

                            if (!hasValidMissions) {
                                noMissionsMessage.style.display = 'block';
                            }

                            // 버튼 이벤트 리스너 (기존과 동일)
                            document.querySelectorAll('.mission-status-toggle').forEach(button => {
                                button.addEventListener('click', function () {
                                    const currentUsercode = this.dataset.usercode;
                                    const missionNumber = parseInt(this.dataset.missionNumber);
                                    let isConfirmed = this.dataset.confirmed === 'true';
                                    isConfirmed = !isConfirmed;

                                    fetch('/update_mission_status', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json', },
                                        body: JSON.stringify({
                                            usercode: currentUsercode,
                                            mission_number: missionNumber,
                                            confirmed: isConfirmed
                                        }),
                                    })
                                    .then(response => response.json())
                                    .then(updateData => {
                                        if (updateData.success) {
                                            this.dataset.confirmed = isConfirmed ? 'true' : 'false';
                                            this.classList.toggle('pending', !isConfirmed);
                                            this.classList.toggle('confirmed', isConfirmed);
                                            this.textContent = isConfirmed ? '미션 완료됨' : '미션 완료하기';
                                        } else {
                                            alert('미션 상태 업데이트 실패: ' + (updateData.error || '알 수 없는 오류'));
                                        }
                                    })
                                    .catch(error => {
                                        console.error('미션 상태 업데이트 중 오류 발생:', error);
                                        alert('미션 상태 업데이트 중 오류가 발생했습니다.');
                                    });
                                });
                            });

                        } else {
                            noMissionsMessage.style.display = 'block';
                            if (data.error) { console.error("서버 오류: ", data.error); }
                        }
                    })
                    .catch(error => {
                        console.error('미션 상세 정보 가져오기 오류:', error);
                        loadingMessage.style.display = 'none';
                        noMissionsMessage.textContent = '미션 정보를 불러오는 데 실패했습니다.';
                        noMissionsMessage.style.display = 'block';
                    });
            } else {
                loadingMessage.style.display = 'none';
                noMissionsMessage.textContent = 'Usercode가 제공되지 않았습니다.';
                noMissionsMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>