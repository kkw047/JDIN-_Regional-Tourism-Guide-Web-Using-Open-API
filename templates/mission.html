<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 미션</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; /* iframe 내부 body의 전체 높이를 사용 */
            box-sizing: border-box;
            background-color: #f8f9fa;
        }

        .mission-container {
            flex-grow: 1; /* 남은 공간을 모두 차지 */
            overflow-y: auto; /* 이 컨테이너에서만 스크롤이 발생하도록 설정 (핵심!) */
            padding: 20px;
            background-color: white;
        }

        .mission-item {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .mission-item h4 {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: bold;
        }

        .mission-item p {
            font-size: 0.95em;
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .mission-status-toggle {
            display: block;
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            text-align: center;
            font-weight: bold;
        }

        .mission-status-toggle.pending {
            background-color: #007bff;
            color: white;
        }

        .mission-status-toggle.pending:hover {
            background-color: #0056b3;
        }

        .mission-status-toggle.confirmed {
            background-color: #28a745;
            color: white;
        }

        .mission-status-toggle.confirmed:hover {
            background-color: #218838;
        }

        .mission-status-toggle:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .no-missions, .loading {
            text-align: center;
            color: #888;
            padding: 30px;
            font-size: 1.1em;
        }

        .mission-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            background-color: #f0f0f0;
            text-align: center;
            flex-shrink: 0; /* 푸터가 줄어들지 않도록 고정 */
            font-size: 0.85em;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="mission-container">
        <div class="loading" id="loadingMessage">미션 정보를 불러오는 중...</div>
        <div id="missionList">
            </div>
        <div class="no-missions" id="noMissionsMessage" style="display: none;">현재 진행 중인 미션이 없습니다.</div>
    </div>
    <div class="mission-footer">
        미션은 관광지당 1개씩 제공됩니다.
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const usercode = urlParams.get('usercode');
            const missionListDiv = document.getElementById('missionList');
            const loadingMessage = document.getElementById('loadingMessage');
            const noMissionsMessage = document.getElementById('noMissionsMessage');

            if (usercode) {
                fetch(`/get_mission_details/${usercode}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(data => {
                            loadingMessage.style.display = 'none';
                            // console.log("미션 데이터 수신 (mission.html):", data);

                            if (data.success && data.missions && data.missions.length > 0) {
                                // data.missions 배열은 null을 포함할 수 있음 (app.py에서 그렇게 반환)
                                let hasValidMissions = false;
                                data.missions.forEach((mission, index) => { // index는 0, 1, 2
                                    if (mission) { // mission 객체가 null이 아닌 경우에만 렌더링
                                        hasValidMissions = true;
                                        const missionItem = document.createElement('div');
                                        missionItem.className = 'mission-item';

                                        // mission.mission_number를 data 속성에 사용 (app.py에서 mission_number로 제공)
                                        // mission.confirmed 값 직접 사용
                                        missionItem.innerHTML = `
                                        <h4>${mission.title}</h4>
                                        <p>${mission.content}</p>
                                        <button class="mission-status-toggle ${mission.confirmed ? 'confirmed' : 'pending'}"
                                                data-mission-number="${mission.mission_number}"
                                                data-usercode="${usercode}"
                                                data-confirmed="${mission.confirmed ? 'true' : 'false'}">
                                            ${mission.confirmed ? '미션 완료됨' : '미션 완료하기'}
                                        </button>
                                    `;
                                        missionListDiv.appendChild(missionItem);
                                    }
                                });

                                if (!hasValidMissions) {
                                    noMissionsMessage.style.display = 'block';
                                }

                                document.querySelectorAll('.mission-status-toggle').forEach(button => {
                                    button.addEventListener('click', function () {
                                        const currentUsercode = this.dataset.usercode;
                                        // data-mission-number 값 사용
                                        const missionNumber = parseInt(this.dataset.missionNumber);
                                        let isConfirmed = this.dataset.confirmed === 'true';

                                        isConfirmed = !isConfirmed; // 상태 토글

                                        fetch('/update_mission_status', { // 새로운 엔드포인트 호출
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({
                                                usercode: currentUsercode,
                                                mission_number: missionNumber, // 'mission_number'로 전달
                                                confirmed: isConfirmed
                                            }),
                                        })
                                                .then(response => response.json())
                                                .then(updateData => {
                                                    if (updateData.success) {
                                                        this.dataset.confirmed = isConfirmed ? 'true' : 'false';
                                                        if (isConfirmed) {
                                                            this.classList.remove('pending');
                                                            this.classList.add('confirmed');
                                                            this.textContent = '미션 완료됨';
                                                        } else {
                                                            this.classList.remove('confirmed');
                                                            this.classList.add('pending');
                                                            this.textContent = '미션 완료하기';
                                                        }
                                                        // mission1.html 처럼 alert(updateData.message)를 표시할 수 있음
                                                        // alert(updateData.message || (isConfirmed ? '미션이 완료되었습니다!' : '미션 완료 상태가 취소되었습니다.'));
                                                    } else {
                                                        alert('미션 상태 업데이트 실패: ' + (updateData.error || '알 수 없는 오류'));
                                                        // 원래 상태로 버튼 복구 (선택 사항)
                                                        // isConfirmed = !isConfirmed;
                                                        // this.dataset.confirmed = isConfirmed ? 'true' : 'false';
                                                        // ... (UI 클래스 및 텍스트 복구)
                                                    }
                                                })
                                                .catch(error => {
                                                    console.error('Error updating mission status:', error);
                                                    alert('미션 상태 업데이트 중 오류가 발생했습니다.');
                                                });
                                    });
                                });

                            } else {
                                noMissionsMessage.style.display = 'block';
                                if (data.error) {
                                    console.error("Error from server: ", data.error);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching mission details:', error);
                            loadingMessage.style.display = 'none';
                            noMissionsMessage.textContent = '미션 정보를 불러오는 데 실패했습니다.';
                            noMissionsMessage.style.display = 'block';
                        });
            } else {
                loadingMessage.style.display = 'none';
                noMissionsMessage.textContent = 'Usercode가 제공되지 않았습니다.';
                noMissionsMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>